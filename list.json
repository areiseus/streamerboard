<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Board</title>
    <style>
        :root { --primary: #42C769; --bg: #F0F2F5; --card: #ffffff; --text: #2f3542; }
        body { margin: 0; background: var(--bg); font-family: 'Pretendard', sans-serif; color: var(--text); }
        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; position: relative; }
        
        header { text-align: center; margin-bottom: 30px; }
        header h1 { color: #333; margin: 0; font-size: 2.5rem; letter-spacing: -1px; }
        
        /* ìš°ì¸¡ ìƒë‹¨ ê´€ë¦¬ì ë²„íŠ¼ */
        .admin-link-btn {
            position: absolute; top: 20px; right: 20px;
            background: white; border: 1px solid #ddd; padding: 8px 15px; border-radius: 20px;
            font-size: 0.85rem; color: #666; cursor: pointer; text-decoration: none; font-weight: bold;
            transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .admin-link-btn:hover { background: #333; color: white; border-color: #333; }

        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 30px;}
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            position: relative; background: var(--card); border-radius: 20px; padding: 25px 15px; text-align: center; 
            cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card.is-live { border-color: #ff4757; background: #fff5f5; }
        
        .profile-wrapper { position: relative; width: 90px; height: 90px; margin: 0 auto 15px; }
        .card img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #eee; background: #eee;}
        
        .badges { position: absolute; bottom: -5px; width: 100%; text-align: center; display: flex; justify-content: center; gap: 5px; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; color: white; }
        
        .badge.live { background: #ff4757; display: none; }
        .card.is-live .badge.live { display: inline-block; }
        
        .badge.soop { background: #42C769; }
        .badge.chzzk { background: #00E59D; color: #1e1e1e; }
        
        .status-text { font-size: 0.85rem; color: #888; margin-top: 5px;}
        .card.is-live .status-text { color: #ff4757; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Streamer Board</h1>
        <p>ì‹¤ì‹œê°„ ë°©ì†¡ í˜„í™© (DB ì—°ë™ë¨)</p>
        <button class="admin-link-btn" onclick="location.href='admin.html'">âš™ï¸ ê´€ë¦¬ì</button>
    </header>

    <div id="dashboard-content" class="grid">
        <p style="text-align:center; width:100%; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</div>

<script>
    // 1. ì´ˆê¸°í™”: DBì—ì„œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function init() {
        try {
            // DB ëª©ë¡ API í˜¸ì¶œ
            const res = await fetch('/api/get_list');
            if(!res.ok) throw new Error("DB ë¡œë“œ ì‹¤íŒ¨");
            
            const streamers = await res.json();
            
            if(streamers.length === 0) {
                document.getElementById('dashboard-content').innerHTML = '<p style="padding:20px; text-align:center;">ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ì¶”ê°€í•˜ê³  [âš¡í”„ë¡œí•„ ê°±ì‹ ]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>';
                return;
            }

            // í™”ë©´ ê·¸ë¦¬ê¸° (ì´ˆê¸° ìƒíƒœ)
            renderCards(streamers);
            
            // ì‹¤ì‹œê°„ ë°©ì†¡ ì—¬ë¶€ í™•ì¸ ì‹œì‘
            fetchLiveStatus(streamers);

        } catch (e) { 
            console.error(e); 
            document.getElementById('dashboard-content').innerHTML = '<p>ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        }
    }

    // 2. ì¹´ë“œ ë Œë”ë§
    function renderCards(list) {
        const container = document.getElementById('dashboard-content');
        container.innerHTML = ''; // ì´ˆê¸°í™”

        list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.id = `card-${item.id}`; // ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ID ë¶€ì—¬
            
            const pClass = item.platform === 'chzzk' ? 'chzzk' : 'soop';
            const pName = item.platform === 'chzzk' ? 'C' : 'S';
            const imgUrl = item.profile_img || 'https://via.placeholder.com/90?text=NoImg';

            card.innerHTML = `
                <div class="profile-wrapper">
                    <img src="${imgUrl}">
                    <div class="badges">
                        <span class="badge ${pClass}">${pName}</span>
                        <span class="badge live">LIVE</span>
                    </div>
                </div>
                <h3>${item.nickname || item.id}</h3>
                <p class="status-text" id="status-${item.id}">ì˜¤í”„ë¼ì¸</p>
            `;
            
            // í´ë¦­ ì‹œ ì´ë™
            let link = item.platform === 'chzzk' 
                ? `https://chzzk.naver.com/live/${item.id}` 
                : `https://play.afreecatv.com/${item.id}`;
                
            card.onclick = () => window.open(link, '_blank');
            container.appendChild(card);
        });
    }

    // 3. ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸ (api/live.js í˜¸ì¶œ)
    async function fetchLiveStatus(streamers) {
        try {
            // DB í˜•ì‹ ë°ì´í„°ë¥¼ APIê°€ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ({id, platform})
            const targets = streamers.map(s => ({ id: s.id, platform: s.platform }));

            const res = await fetch('/api/live', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: targets })
            });
            
            const results = await res.json();
            updateUI(results);

        } catch (e) { console.error("ë¼ì´ë¸Œ ì²´í¬ ì‹¤íŒ¨:", e); }
    }

    // 4. ìƒíƒœ ì—…ë°ì´íŠ¸ (ìƒ‰ìƒ, í…ìŠ¤íŠ¸ ë³€ê²½)
    function updateUI(results) {
        results.forEach(r => {
            const card = document.getElementById(`card-${r.id}`);
            const statusText = document.getElementById(`status-${r.id}`);
            if(!card || !statusText) return;

            if(r.isLive) {
                card.classList.add('is-live');
                statusText.innerText = `ğŸ”´ ${r.viewers ? r.viewers.toLocaleString() : 'ë°©ì†¡ì¤‘'}`;
            } else {
                card.classList.remove('is-live');
                statusText.innerText = 'âš« ì˜¤í”„ë¼ì¸';
            }
        });
    }

    init();
</script>

</body>
</html>
