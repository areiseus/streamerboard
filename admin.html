<script>
    // --- ì „ì—­ ë³€ìˆ˜ ---
    let draftList = []; 
    let groupSet = new Set(); 

    // 1. ë¡œê·¸ì¸ (admin.json ì²´í¬)
    async function checkLogin() {
        try {
            const res = await fetch('admin.json');
            if(!res.ok) throw new Error("admin.json íŒŒì¼ ì—†ìŒ");
            const cfg = await res.json();
            
            if(document.getElementById('adminPw').value === cfg.password) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                init();
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            }
        } catch(e) {
            alert('ë¡œê·¸ì¸ ì˜¤ë¥˜: ' + e.message);
        }
    }

    async function init() {
        await loadDBList(); 
    }

    // 2. ê·¸ë£¹ ê´€ë¦¬ (HTML ë¡œì»¬)
    function addGroupLocal() {
        const name = document.getElementById('localGroupName').value.trim();
        if(!name) return alert('ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        groupSet.add(name); 
        renderGroups();
        document.getElementById('localGroupName').value = '';
    }

    function renderGroups() {
        // ë±ƒì§€ í‘œì‹œ
        const badgeArea = document.getElementById('groupBadgeArea');
        if(badgeArea) {
            badgeArea.innerHTML = '';
            [...groupSet].forEach(g => {
                badgeArea.innerHTML += `<span style="background:#555; padding:5px 10px; border-radius:15px; font-size:0.8rem; margin-right:5px;">ğŸ“‚ ${g}</span>`;
            });
        }

        // ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°±ì‹ 
        const sel = document.getElementById('selGroup');
        sel.innerHTML = '<option value="">ê·¸ë£¹ ì„ íƒ</option>';
        [...groupSet].sort().forEach(g => {
            sel.innerHTML += `<option value="${g}">${g}</option>`;
        });
    }

    // ==========================================
    // [ì¤‘ìš”] ì—¬ê¸°ê°€ ìˆ˜ì •ëœ ë£©ì—… í•¨ìˆ˜ì…ë‹ˆë‹¤
    // ==========================================
    async function lookupAndAdd() {
        // 1. HTML íƒœê·¸ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ë³€ìˆ˜ ì„ ì–¸ í™•ì‹¤í•˜ê²Œ)
        const group_name = document.getElementById('selGroup').value;
        const platform = document.getElementById('selPlatform').value;
        const idInput = document.getElementById('inpId'); // íƒœê·¸ ìì²´ë¥¼ ë¨¼ì € ì°¾ìŒ
        
        if (!idInput) {
            alert('ì˜¤ë¥˜: HTMLì— id="inpId"ì¸ ì…ë ¥ì°½ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const id = idInput.value.trim(); // ê°’ ì¶”ì¶œ

        // 2. ìœ íš¨ì„± ê²€ì‚¬
        if(!group_name) return alert('ê·¸ë£¹ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
        if(!id) return alert('ìŠ¤íŠ¸ë¦¬ë¨¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        // 3. ì´ë¯¸ ëŒ€ê¸°ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
        if(draftList.find(d => d.id === id)) return alert('ì´ë¯¸ ì•„ë˜ ëŒ€ê¸° ëª©ë¡ì— ìˆìŠµë‹ˆë‹¤.');

        try {
            // 4. ì„œë²„ë¡œ ì¡°íšŒ ìš”ì²­
            // (ë³€ìˆ˜ëª… id, platformì´ ì •í™•íˆ ë„˜ì–´ê°€ëŠ”ì§€ í™•ì¸)
            const res = await fetch('/api/lookup', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, platform: platform }) 
            });

            // ì„œë²„ ì‘ë‹µ ì—ëŸ¬ ì²˜ë¦¬
            if (!res.ok) {
                const errData = await res.json();
                throw new Error(errData.error || 'ì„œë²„ ì˜¤ë¥˜ ë°œìƒ');
            }

            const data = await res.json();

            if(data.status === 'duplicate') return alert('ì´ë¯¸ DBì— ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ì…ë‹ˆë‹¤.');

            // 5. ì„±ê³µ ì‹œ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ (nicknameì€ ì„œë²„ì—ì„œ ë°›ì•„ì˜´)
            draftList.push({
                group_name: group_name, 
                platform: platform,
                id: id,
                nickname: data.nickname || id
            });
            
            renderDraft();
            document.getElementById('inpId').value = ''; // ì…ë ¥ì°½ ë¹„ìš°ê¸°

        } catch(e) { 
            alert('ì¡°íšŒ ì‹¤íŒ¨: ' + e.message); 
            console.error(e);
        }
    }

    function renderDraft() {
        const tbody = document.getElementById('draftBody');
        tbody.innerHTML = draftList.map((item, idx) => `
            <tr>
                <td style="color:#f1c40f;">${item.group_name}</td>
                <td><span class="badge ${item.platform}">${item.platform}</span></td>
                <td>${item.id}</td>
                <td>${item.nickname}</td>
                <td><button onclick="removeDraft(${idx})" style="background:#e74c3c; padding:4px 8px; font-size:0.8rem;">ì·¨ì†Œ</button></td>
            </tr>
        `).join('');
    }

    function removeDraft(idx) {
        draftList.splice(idx, 1);
        renderDraft();
    }

    // 4. [ìµœì´ˆ ë“±ë¡] ì‹¤í–‰ (DB ì €ì¥)
    async function saveBatch() {
        if(draftList.length === 0) return alert('ì €ì¥í•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        
        const btn = document.querySelector('button[onclick="saveBatch()"]');
        btn.innerText = 'â³ ì €ì¥ ì¤‘...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/register_batch', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: draftList })
            });
            
            const result = await res.json();

            if(res.ok) {
                alert(`âœ… ${result.count}ëª… ì €ì¥ ì™„ë£Œ!`);
                draftList = [];
                renderDraft();
                loadDBList(); 
            } else {
                throw new Error(result.error);
            }
        } catch(e) { 
            alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); 
        }
        
        btn.innerText = 'ğŸ’¾ [DBì— ìµœì¢… ì €ì¥í•˜ê¸°]';
        btn.disabled = false;
    }

    // 5. DB ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadDBList() {
        try {
            const res = await fetch('/api/get_list');
            const data = await res.json();

            // ê¸°ì¡´ DBì— ìˆë˜ ê·¸ë£¹ë“¤ë„ ì„ íƒ ëª©ë¡ì— ì¶”ê°€
            data.forEach(m => { if(m.group_name) groupSet.add(m.group_name); });
            renderGroups();

            document.getElementById('totalCnt').innerText = data.length;
            const tbody = document.getElementById('dbBody');
            tbody.innerHTML = data.map(m => `
                <tr>
                    <td style="color:#f1c40f;">${m.group_name || '-'}</td>
                    <td><span class="badge ${m.platform}">${m.platform}</span></td>
                    <td>${m.id}</td>
                    <td>${m.nickname}</td>
                    <td style="font-size:0.8rem; color:#aaa;">${m.station_open_date || '-'}</td>
                    <td>${m.is_active ? 'âœ…' : 'ğŸš«'}</td>
                </tr>
            `).join('');
        } catch(e) {
            console.error("ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", e);
        }
    }

    // 6. [ëª¨ë‘ ê°±ì‹ ]
    async function updateFull() {
        if(!confirm('ëª¨ë“  ë°ì´í„°(ì „ì¼í†µê³„/ê²Œì‹œê¸€ìˆ˜ ë“±)ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.')) return;
        const btn = document.querySelector('button[onclick="updateFull()"]');
        btn.innerText = 'â³ ê°±ì‹  ì¤‘...';
        await fetch('/api/sync_full', { method:'POST' });
        alert('ê°±ì‹  ì™„ë£Œ');
        btn.innerText = 'ğŸ”„ [ëª¨ë‘ ê°±ì‹ ] (ì „ì¼í†µê³„/ê²Œì‹œê¸€ìˆ˜ ë“±)';
        loadDBList();
    }
</script>
