<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: 'Pretendard', sans-serif; max-width: 1200px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { background: #333; padding: 40px; border-radius: 10px; border: 1px solid #555; text-align: center; width: 300px; }
        
        /* ë©”ì¸ ì»¨í…ì¸  */
        #adminContent { display: none; }
        .panel { background: #333; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; }
        
        input, select { padding: 10px; background: #444; border: 1px solid #555; color: white; border-radius: 4px; margin-right: 5px; box-sizing: border-box; }
        button { cursor: pointer; border: none; border-radius: 4px; padding: 10px 15px; color: white; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        
        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th { background: #444; padding: 10px; text-align: center; border-bottom: 2px solid #555; }
        td { border-bottom: 1px solid #555; padding: 10px; text-align: center; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; color:black; font-weight: bold;}
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
        
        /* ê°•ì¡° */
        .highlight { color: #f1c40f; font-weight: bold; font-size: 1.1rem; }
        .step-box { border-left: 5px solid #3498db; padding-left: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2>ğŸ”’ ê´€ë¦¬ì ì ‘ì†</h2>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:100%; margin-bottom:10px;" onkeyup="if(event.key==='Enter') checkLogin()">
            <button onclick="checkLogin()" style="background:#0984e3; width:100%;">í™•ì¸</button>
        </div>
    </div>

    <div id="adminContent">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>ğŸ› ï¸ ìŠ¤íŠ¸ë¦¬ë¨¸ DB ê´€ë¦¬ì</h2>
            <a href="index.html" style="color:#aaa; text-decoration:none; font-size:1.5rem;">ğŸ </a>
        </div>

        <div class="panel" style="border: 2px solid #3498db;">
            <h3>ğŸ“ 1. ë“±ë¡ ëŒ€ê¸° ë¦¬ìŠ¤íŠ¸ ì‘ì„± (HTML ì„ì‹œ)</h3>
            
            <div class="step-box">
                <div style="margin-bottom:10px;"><span class="highlight">STEP 1. ê·¸ë£¹ ìƒì„±</span></div>
                <input type="text" id="localGroupName" placeholder="ê·¸ë£¹ëª… (ì˜ˆ: ì™íƒ€ë²„ìŠ¤, ì´ì„¸ëŒ)" style="width: 250px;">
                <button onclick="addGroupLocal()" style="background:#2ecc71;">â• ê·¸ë£¹ ì¶”ê°€</button>
                <div id="groupBadgeArea" style="margin-top:10px; display:flex; gap:5px; flex-wrap:wrap;">
                    </div>
            </div>

            <div class="step-box">
                <div style="margin-bottom:10px;"><span class="highlight">STEP 2. ìŠ¤íŠ¸ë¦¬ë¨¸ ë¦¬ìŠ¤íŠ¸ì—…</span></div>
                
                <select id="selGroup">
                    <option value="">ê·¸ë£¹ ì„ íƒ (ìœ„ì—ì„œ ìƒì„±)</option>
                </select>

                <select id="selPlatform">
                    <option value="soop">SOOP (ìˆ²)</option>
                    <option value="chzzk">CHZZK (ì¹˜ì§€ì§)</option>
                </select>
                
                <input type="text" id="inpId" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ID (UID)" style="width:200px;">
                <button onclick="lookupAndAdd()" style="background:#3498db;">â¬‡ï¸ ì•„ë˜ ëª©ë¡ì— ë‹´ê¸°</button>
            </div>

            <table style="background:#2a3b4c; margin-top:10px;">
                <thead>
                    <tr><th colspan="5" style="background:#2980b9;">ğŸ’¾ ì €ì¥ ëŒ€ê¸° ëª©ë¡ (ì•„ë˜ [DB ì €ì¥] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ì €ì¥ë©ë‹ˆë‹¤)</th></tr>
                    <tr><th>ê·¸ë£¹</th><th>í”Œë«í¼</th><th>ID</th><th>ë‹‰ë„¤ì„ (í™•ì¸ìš©)</th><th>ì œê±°</th></tr>
                </thead>
                <tbody id="draftBody"></tbody>
            </table>

            <div style="text-align:right; margin-top:20px;">
                <button onclick="saveBatch()" style="background:#e67e22; font-size:1.2rem; padding:15px 30px;">
                    ğŸ’¾ [DBì— ìµœì¢… ì €ì¥í•˜ê¸°]
                </button>
            </div>
        </div>

        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“‹ 2. DB ë“±ë¡ í˜„í™© (<span id="totalCnt">0</span>ëª…)</h3>
                <button onclick="updateFull()" style="background:#e74c3c;">ğŸ”„ [ëª¨ë‘ ê°±ì‹ ] (ì „ì¼í†µê³„/ê²Œì‹œê¸€ìˆ˜ ë“±)</button>
            </div>
            <table>
                <thead>
                    <tr><th>ê·¸ë£¹</th><th>í”Œë«í¼</th><th>ID</th><th>ë‹‰ë„¤ì„</th><th>ë°©ì†¡êµ­ ê°œì„¤ì¼</th><th>ìƒíƒœ</th></tr>
                </thead>
                <tbody id="dbBody"></tbody>
            </table>
        </div>
    </div>

<script>
    // --- ìƒíƒœ ë³€ìˆ˜ ---
    let draftList = []; 
    let groupSet = new Set(); // ì¤‘ë³µ ë°©ì§€ìš© ê·¸ë£¹ ëª©ë¡

    // 1. ë¡œê·¸ì¸
    async function checkLogin() {
        try {
            const res = await fetch('admin.json');
            if(!res.ok) throw new Error("admin.json íŒŒì¼ ì—†ìŒ");
            const cfg = await res.json();
            
            if(document.getElementById('adminPw').value === cfg.password) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                init(); 
            } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.'); }
        } catch(e) { alert('ì˜¤ë¥˜: ' + e.message); }
    }

    async function init() {
        await loadDBList(); 
    }

    // 2. [STEP 1] ê·¸ë£¹ ìƒì„± (HTML ë¡œì»¬)
    function addGroupLocal() {
        const name = document.getElementById('localGroupName').value.trim();
        if(!name) return alert('ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        
        groupSet.add(name); // Setì— ì¶”ê°€
        renderGroups();
        document.getElementById('localGroupName').value = '';
    }

    function renderGroups() {
        // 1) ë±ƒì§€ í‘œì‹œ
        const badgeArea = document.getElementById('groupBadgeArea');
        badgeArea.innerHTML = '';
        [...groupSet].forEach(g => {
            badgeArea.innerHTML += `<span style="background:#555; padding:5px 10px; border-radius:15px; font-size:0.8rem;">ğŸ“‚ ${g}</span>`;
        });

        // 2) ì…€ë ‰íŠ¸ ë°•ìŠ¤ ê°±ì‹ 
        const sel = document.getElementById('selGroup');
        sel.innerHTML = '<option value="">ê·¸ë£¹ ì„ íƒ (ìœ„ì—ì„œ ìƒì„±)</option>';
        [...groupSet].sort().forEach(g => {
            sel.innerHTML += `<option value="${g}">${g}</option>`;
        });
    }

    // 3. [STEP 2] ë¦¬ìŠ¤íŠ¸ì—… (Draft)
    // admin.html ë‚´ë¶€ lookupAndAdd í•¨ìˆ˜ ìˆ˜ì •
async function lookupAndAdd() {
    // ... (ì•ë¶€ë¶„ ë™ì¼) ...

    try {
        const res = await fetch('/api/lookup', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, platform })
        });
        
        // [ì¶”ê°€ë¨] ì„œë²„ê°€ ì—ëŸ¬ë¥¼ ë±‰ì—ˆëŠ”ì§€ í™•ì¸
        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || 'ì„œë²„ ì˜¤ë¥˜');
        }

        const data = await res.json();
        // ... (ë‚˜ë¨¸ì§€ ë¡œì§ ë™ì¼) ...

    } catch(e) { 
        // [ìˆ˜ì •ë¨] ê·¸ëƒ¥ 'ì˜¤ë¥˜ ë°œìƒ'ì´ë¼ê³  í•˜ì§€ ë§ê³  ì—ëŸ¬ ë‚´ìš©ì„ ì¶œë ¥
        alert('ì¡°íšŒ ì‹¤íŒ¨: ' + e.message); 
        console.error(e);
    }
}

    
// admin.html ë‚´ë¶€ lookupAndAdd í•¨ìˆ˜ ìˆ˜ì •
async function lookupAndAdd() {
    // ... (ì•ë¶€ë¶„ ë™ì¼) ...

    try {
        const res = await fetch('/api/lookup', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, platform })
        });
        
        // [ì¶”ê°€ë¨] ì„œë²„ê°€ ì—ëŸ¬ë¥¼ ë±‰ì—ˆëŠ”ì§€ í™•ì¸
        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.error || 'ì„œë²„ ì˜¤ë¥˜');
        }

        const data = await res.json();
        // ... (ë‚˜ë¨¸ì§€ ë¡œì§ ë™ì¼) ...

    } catch(e) { 
        // [ìˆ˜ì •ë¨] ê·¸ëƒ¥ 'ì˜¤ë¥˜ ë°œìƒ'ì´ë¼ê³  í•˜ì§€ ë§ê³  ì—ëŸ¬ ë‚´ìš©ì„ ì¶œë ¥
        alert('ì¡°íšŒ ì‹¤íŒ¨: ' + e.message); 
        console.error(e);
    }
}

    function renderDraft() {
        const tbody = document.getElementById('draftBody');
        tbody.innerHTML = draftList.map((item, idx) => `
            <tr>
                <td style="color:#f1c40f;">${item.group_id}</td>
                <td><span class="badge ${item.platform}">${item.platform}</span></td>
                <td>${item.id}</td>
                <td>${item.nickname}</td>
                <td><button onclick="removeDraft(${idx})" style="background:#e74c3c; padding:4px 8px; font-size:0.8rem;">ì·¨ì†Œ</button></td>
            </tr>
        `).join('');
    }

    function removeDraft(idx) {
        draftList.splice(idx, 1);
        renderDraft();
    }

    // 4. [STEP 3] ìµœì¢… DB ì €ì¥
    async function saveBatch() {
        if(draftList.length === 0) return alert('ì €ì¥í•  ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        if(!confirm(`ì´ ${draftList.length}ëª…ì˜ ìŠ¤íŠ¸ë¦¬ë¨¸ë¥¼ DBì— ì €ì¥í•©ë‹ˆë‹¤.\n(ìƒì„¸ ì •ë³´ ìˆ˜ì§‘ í¬í•¨)`)) return;

        const btn = document.querySelector('button[onclick="saveBatch()"]');
        btn.innerText = 'â³ ì €ì¥ ë° ìˆ˜ì§‘ ì¤‘...';

        try {
            const res = await fetch('/api/register_batch', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: draftList })
            });
            
            if(res.ok) {
                alert('âœ… ì €ì¥ ì™„ë£Œ!');
                draftList = [];
                renderDraft();
                loadDBList(); 
            } else {
                alert('ì €ì¥ ì‹¤íŒ¨');
            }
        } catch(e) { console.error(e); alert('ì˜¤ë¥˜ ë°œìƒ'); }
        
        btn.innerText = 'ğŸ’¾ [DBì— ìµœì¢… ì €ì¥í•˜ê¸°]';
    }

    // 5. DB ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadDBList() {
        const res = await fetch('/api/get_list');
        const data = await res.json();

        // ê¸°ì¡´ DBì— ìˆë˜ ê·¸ë£¹ë“¤ë„ ê·¸ë£¹ ì„ íƒ ëª©ë¡ì— ìë™ ì¶”ê°€
        data.forEach(m => { if(m.group_id) groupSet.add(m.group_id); });
        renderGroups();

        document.getElementById('totalCnt').innerText = data.length;
        const tbody = document.getElementById('dbBody');
        tbody.innerHTML = data.map(m => `
            <tr>
                <td style="color:#f1c40f;">${m.group_id}</td>
                <td><span class="badge ${m.platform}">${m.platform}</span></td>
                <td>${m.id}</td>
                <td>${m.nickname}</td>
                <td style="font-size:0.8rem; color:#aaa;">${m.station_open_date || '-'}</td>
                <td>${m.is_active ? 'âœ…' : 'ğŸš«'}</td>
            </tr>
        `).join('');
    }

    // 6. ëª¨ë‘ ê°±ì‹ 
    async function updateFull() {
        if(!confirm('ëª¨ë“  ë°ì´í„°(ì „ì¼í†µê³„/ê²Œì‹œê¸€ìˆ˜ ë“±)ë¥¼ ê°±ì‹ í•©ë‹ˆë‹¤.')) return;
        const btn = document.querySelector('button[onclick="updateFull()"]');
        btn.innerText = 'â³ ê°±ì‹  ì¤‘...';
        await fetch('/api/sync_full', { method:'POST' });
        alert('ê°±ì‹  ì™„ë£Œ');
        btn.innerText = 'ğŸ”„ [ëª¨ë‘ ê°±ì‹ ] (ì „ì¼í†µê³„/ê²Œì‹œê¸€ìˆ˜ ë“±)';
        loadDBList();
    }
</script>
</body>
</html>
