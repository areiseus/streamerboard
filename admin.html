<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Admin Pro</title>
    <style>
        :root { --bg: #1e1e2e; --card: #2b2b3b; --text: #cdd6f4; --accent: #89b4fa; --danger: #f38ba8; --success: #a6e3a1; }
        body { background: var(--bg); color: var(--text); font-family: 'Pretendard', sans-serif; margin: 0; padding: 20px; }
        h2, h3 { border-bottom: 2px solid #444; padding-bottom: 10px; margin-top: 30px; }
        
        /* ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1200px; margin: 0 auto; }
        .grid-box { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }

        /* ì…ë ¥ í¼ */
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #555; background: #333; color: white; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; font-weight: bold; border: none; transition: 0.2s; }
        button.primary { background: var(--accent); color: #111; }
        button.danger { background: var(--danger); color: #111; }
        button.success { background: var(--success); color: #111; }
        button:hover { opacity: 0.8; }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #444; }
        th { background: #333; color: var(--accent); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .soop { background: #42C769; color: #fff; } .chzzk { background: #00E59D; color: #111; }

        /* ëª¨ë‹¬ (í†µê³„ íŒì—…) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); width: 80%; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 15px; }
        .close-btn { float: right; font-size: 1.5rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>ğŸ› ï¸ í†µí•© ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
        <div>
            <button onclick="openStats()" class="primary" style="width:auto; padding:10px 20px;">ğŸ“Š ì›”ê°„/ì£¼ê°„ í†µê³„ ë¶„ì„</button>
            <a href="index.html"><button style="width:auto; background:#555;">ğŸ  ë©”ì¸ìœ¼ë¡œ</button></a>
        </div>
    </div>

    <div class="grid-box">
        <div class="card">
            <h3>ğŸ“‚ ê·¸ë£¹ ê´€ë¦¬</h3>
            <input type="text" id="newGroupName" placeholder="ìƒˆ ê·¸ë£¹ëª… (ì˜ˆ: ì™íƒ€ë²„ìŠ¤)">
            <button onclick="addGroup()" class="success">â• ê·¸ë£¹ ìƒì„±</button>
            <div id="groupListArea" style="margin-top:20px;">
                </div>
        </div>

        <div class="card">
            <h3>ğŸ‘¤ ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡ (ìµœì´ˆ 1íšŒ)</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;">
                <select id="regPlatform">
                    <option value="soop">SOOP (ìˆ²)</option>
                    <option value="chzzk">CHZZK (ì¹˜ì§€ì§)</option>
                </select>
                <input type="text" id="regId" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ID/UID">
                <select id="regGroup">
                    <option value="">ê·¸ë£¹ ì„ íƒ</option>
                </select>
                <button onclick="registerStreamer()" class="primary">ğŸ’¾ ë“±ë¡ ë° ì •ë³´ìˆ˜ì§‘</button>
            </div>
            <p style="font-size:0.8rem; color:#aaa;">* ìµœì´ˆ ë“±ë¡ ì‹œ: ë°©ì†¡êµ­ ê°œì„¤ì¼, í”„ë¡œí•„ ì‚¬ì§„, ê¸°ë³¸ ì •ë³´ë¥¼ ì¦‰ì‹œ ê¸ì–´ì˜µë‹ˆë‹¤.</p>
        </div>
    </div>

    <div class="card" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>ğŸ“‹ ê´€ë¦¬ ëª©ë¡ (ì´ <span id="totalCount">0</span>ëª…)</h3>
            <div>
                <button onclick="updateLiveStatus()" style="background:#f1c40f; color:black; width:auto;">âš¡ ì‹¤ì‹œê°„(Live) ê°±ì‹ </button>
                <button onclick="updateAllData()" class="danger" style="width:auto;">ğŸ”„ [ëª¨ë‘ ê°±ì‹ ] ì–´ì œ ë°ì´í„°/ë°©ì†¡ê¸°ë¡</button>
            </div>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>ê·¸ë£¹</th>
                    <th>í”Œë«í¼</th>
                    <th>ë‹‰ë„¤ì„ (ID)</th>
                    <th>ë°©ì†¡êµ­ ê°œì„¤ì¼</th>
                    <th>ìµœê·¼ ë°©ì†¡</th>
                    <th>ì–´ì œ í†µê³„ (ìµœëŒ€/í‰ê· )</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody id="streamerTable"></tbody>
        </table>
    </div>
</div>

<div id="statsModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeStats()">&times;</span>
        <h3>ğŸ“ˆ ë°©ì†¡ í†µê³„ ë¶„ì„ (í›„ì²˜ë¦¬ ë°ì´í„°)</h3>
        <div style="margin-bottom:15px;">
            <button onclick="calculateStats('weekly')" style="width:auto;">ì´ë²ˆ ì£¼ ìš”ì•½</button>
            <button onclick="calculateStats('monthly')" style="width:auto;">ì´ë²ˆ ë‹¬ ìš”ì•½</button>
        </div>
        <div id="statsResult">
            <p>ë¶„ì„í•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>
    </div>
</div>

<script>
    // --- [1] ë°ì´í„° ê´€ë¦¬ ë³€ìˆ˜ ---
    let groups = [];
    let streamers = [];
    let historyData = []; // ë°©ì†¡ ê¸°ë¡ (Mockup for UI)

    // --- [2] ì´ˆê¸° ë¡œë”© ---
    window.onload = async function() {
        await loadGroups();
        await loadStreamers();
    };

    // --- [3] ê·¸ë£¹ ê´€ë¦¬ ë¡œì§ ---
    async function loadGroups() {
        // API ì—°ë™ ì‹œ: const res = await fetch('/api/groups'); groups = await res.json();
        // ì„ì‹œ ë°ì´í„° (ë°±ì—”ë“œ ì—†ì„ ë•Œ í…ŒìŠ¤íŠ¸ìš©)
        if(groups.length === 0) groups = ['ì™íƒ€ë²„ìŠ¤', 'ê¸°íƒ€']; 
        renderGroups();
        updateGroupSelect();
    }

    async function addGroup() {
        const name = document.getElementById('newGroupName').value;
        if(!name) return alert('ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        if(groups.includes(name)) return alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ì…ë‹ˆë‹¤.');

        groups.push(name);
        // TODO: await fetch('/api/groups', { method: 'POST', body: ... })
        document.getElementById('newGroupName').value = '';
        renderGroups();
        updateGroupSelect();
    }

    function deleteGroup(name) {
        if(!confirm(`'${name}' ê·¸ë£¹ì„ ì‚­ì œí•©ë‹ˆê¹Œ? ì†Œì†ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ëŠ” ë¯¸ë¶„ë¥˜ ì²˜ë¦¬ë©ë‹ˆë‹¤.`)) return;
        groups = groups.filter(g => g !== name);
        // TODO: API í˜¸ì¶œ
        renderGroups();
        updateGroupSelect();
    }

    function renderGroups() {
        const area = document.getElementById('groupListArea');
        area.innerHTML = groups.map(g => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #444; padding:5px;">
                <span>ğŸ“‚ ${g}</span>
                <button onclick="deleteGroup('${g}')" style="width:auto; padding:2px 8px; font-size:0.8rem; background:#444;">âŒ</button>
            </div>
        `).join('');
    }

    function updateGroupSelect() {
        const sel = document.getElementById('regGroup');
        sel.innerHTML = '<option value="">ê·¸ë£¹ ì„ íƒ</option>';
        groups.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
    }

    // --- [4] ìŠ¤íŠ¸ë¦¬ë¨¸ ê´€ë¦¬ ë¡œì§ ---
    async function loadStreamers() {
        try {
            const res = await fetch('/api/get_list');
            streamers = await res.json();
            document.getElementById('totalCount').innerText = streamers.length;
            renderStreamerTable();
        } catch(e) { console.error("ë¡œë“œ ì‹¤íŒ¨", e); }
    }

    async function registerStreamer() {
        const platform = document.getElementById('regPlatform').value;
        const id = document.getElementById('regId').value;
        const group = document.getElementById('regGroup').value;

        if(!id || !group) return alert("IDì™€ ê·¸ë£¹ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.");

        // [ìµœì´ˆ ë“±ë¡] API í˜¸ì¶œ -> ë°±ì—”ë“œì—ì„œ ë°©ì†¡êµ­ ê°œì„¤ì¼, í”„ì‚¬ ë“± ê¸ì–´ì˜´
        try {
            await fetch('/api/register', { // sync ëŒ€ì‹  register ì‚¬ìš© ê¶Œì¥
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, platform, group_name: group })
            });
            alert(`âœ… ${id} ë“±ë¡ ì™„ë£Œ! ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.`);
            loadStreamers();
        } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨"); }
    }

    function renderStreamerTable() {
        const tbody = document.getElementById('streamerTable');
        tbody.innerHTML = streamers.map(s => {
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ '-' í‘œì‹œ
            const openDate = s.open_date || '-'; 
            const lastCast = s.last_broadcast_date || '-';
            const yesterdayMax = s.stats_yesterday?.max_viewers || '-';
            const yesterdayAvg = s.stats_yesterday?.avg_viewers || '-';

            return `
                <tr>
                    <td>${s.group_name}</td>
                    <td><span class="badge ${s.platform}">${s.platform}</span></td>
                    <td>
                        <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                            <img src="${s.profile_img || ''}" style="width:20px; height:20px; border-radius:50%;">
                            ${s.nickname || s.id}
                        </div>
                    </td>
                    <td style="font-size:0.8rem; color:#aaa;">${openDate}</td>
                    <td>${lastCast}</td>
                    <td>ğŸ”º${yesterdayMax} / â–${yesterdayAvg}</td>
                    <td>
                        <button onclick="deleteStreamer('${s.id}')" style="background:#444; font-size:0.8rem; padding:4px 8px;">ì‚­ì œ</button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function deleteStreamer(id) {
        if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        // await fetch('/api/delete', ... )
        alert('ì‚­ì œ ê¸°ëŠ¥ì€ API êµ¬í˜„ì´ í•„ìš”í•©ë‹ˆë‹¤.'); 
    }

    // --- [5] ê°±ì‹  ë¡œì§ (í•µì‹¬) ---

    // 1. ì‹¤ì‹œê°„ ê°±ì‹  (ê°€ë²¼ì›€)
    async function updateLiveStatus() {
        alert("âš¡ ì‹¤ì‹œê°„ ë°©ì†¡ ì—¬ë¶€ì™€ í˜„ì¬ ì‹œì²­ì ìˆ˜ë§Œ ë¹ ë¥´ê²Œ í™•ì¸í•©ë‹ˆë‹¤.");
        // await fetch('/api/live_check_only'); 
        location.reload();
    }

    // 2. ëª¨ë‘ ê°±ì‹  (ë¬´ê±°ì›€ - ë§¤ì¼ 1íšŒ ê¶Œì¥)
    async function updateAllData() {
        if(!confirm("âš ï¸ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.\n\n[ê°±ì‹  í•­ëª©]\n- ì–´ì œ ë°©ì†¡ ê¸°ë¡(ì‹œê°„, ì‹œì²­ììˆ˜)\n- ê²Œì‹œê¸€/í´ë¦½ ìˆ˜\n- ëˆ„ë½ëœ ê¸°ë³¸ ì •ë³´\n\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        try {
            const btn = document.querySelector('button[onclick="updateAllData()"]');
            btn.innerText = "â³ ë°ì´í„° ìˆ˜ì§‘ ì¤‘... (í˜ì´ì§€ ë‹«ì§€ ë§ˆì„¸ìš”)";
            
            // ì „ì²´ ìŠ¤íŠ¸ë¦¬ë¨¸ ID ì „ì†¡
            const targets = streamers.map(s => ({ id: s.id, platform: s.platform }));
            
            await fetch('/api/sync_full', { // ì „ì²´ ê°±ì‹  ì „ìš© API
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: targets })
            });

            alert("âœ… ëª¨ë“  ë°ì´í„° ê°±ì‹  ì™„ë£Œ!");
            location.reload();
        } catch(e) {
            alert("ê°±ì‹  ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            console.error(e);
        }
    }

    // --- [6] í†µê³„ / í›„ì²˜ë¦¬ (íŒì—…) ---
    function openStats() { document.getElementById('statsModal').style.display = 'flex'; }
    function closeStats() { document.getElementById('statsModal').style.display = 'none'; }

    async function calculateStats(period) {
        const resDiv = document.getElementById('statsResult');
        resDiv.innerHTML = "â³ ë°ì´í„° ë¶„ì„ ë° ê³„ì‚° ì¤‘...";

        // ì—¬ê¸°ì„œ ë°±ì—”ë“œì˜ 'í›„ì²˜ë¦¬ API'ë¥¼ í˜¸ì¶œí•´ì•¼ í•¨
        // const res = await fetch(`/api/analyze?period=${period}`);
        // const data = await res.json();

        // [í™”ë©´ ì˜ˆì‹œ]
        setTimeout(() => {
            resDiv.innerHTML = `
                <table style="width:100%">
                    <thead>
                        <tr><th>ê·¸ë£¹</th><th>ë°©ì†¡ íšŸìˆ˜</th><th>ì´ ë°©ì†¡ì‹œê°„</th><th>í‰ê·  ì‹œì²­ì</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>ì™íƒ€ë²„ìŠ¤</td><td>15íšŒ</td><td>45ì‹œê°„</td><td>12,500ëª…</td></tr>
                        <tr><td>ê¸°íƒ€</td><td>5íšŒ</td><td>10ì‹œê°„</td><td>2,300ëª…</td></tr>
                    </tbody>
                </table>
                <p style="margin-top:10px; color:#aaa;">* ê¸°ê°„: ${period === 'weekly' ? 'ì´ë²ˆ ì£¼' : 'ì´ë²ˆ ë‹¬'}</p>
            `;
        }, 500);
    }

</script>
</body>
</html>
