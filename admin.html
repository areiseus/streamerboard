<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: sans-serif; max-width: 800px; margin: 0 auto; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-save { width: 100%; background: #00cec9; font-weight: bold; font-size: 1.2rem; cursor: pointer; padding: 15px; border: none; margin-bottom: 20px; border-radius: 8px; }
        .btn-save:hover { background: #00b5b0; }
        .btn-save:disabled { background: #777; cursor: not-allowed; }

        input, select, button { padding: 10px; margin: 5px; border-radius: 5px; border: none; }
        input { background: #444; color: white; border: 1px solid #555; }
        
        .group-box { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; }
        .member-row { background: #444; padding: 8px 10px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; }
        .badge { padding: 3px 6px; border-radius: 3px; font-size: 0.8rem; margin-right: 5px; color: #000; font-weight: bold; }
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
    </style>
</head>
<body>

    <h2 style="text-align:center">ğŸ› ï¸ UI ë°°ì¹˜ ê´€ë¦¬ì</h2>
    <div style="text-align:center; margin-bottom:20px">
        <a href="index.html" style="color:#aaa; text-decoration:none;">ğŸ  ë©”ì¸ í™”ë©´ í™•ì¸í•˜ê¸°</a>
    </div>

    <button onclick="saveAndSync()" class="btn-save" id="saveBtn">ğŸ’¾ ë°°ì¹˜ ì €ì¥í•˜ê¸° (DB ìë™ ë™ê¸°í™”)</button>

    <div style="text-align:center; background:#111; padding:15px; margin-bottom:20px; border-radius:10px;">
        <input type="text" id="gName" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„">
        <button onclick="addGroup()" style="background:#6c5ce7; color:white">ê·¸ë£¹ ìƒì„±</button>
        <hr style="border-color:#333; margin:15px 0;">
        
        <select id="pf">
            <option value="soop">ğŸŒ² ìˆ² (SOOP)</option>
            <option value="chzzk">âš¡ ì¹˜ì§€ì§ (CHZZK)</option>
        </select>
        <input type="text" id="mId" placeholder="ì•„ì´ë”” (UID)">
        <select id="targetG"></select>
        <button onclick="addMember()" style="background:#0984e3; color:white">ë©¤ë²„ ì¶”ê°€</button>
    </div>

    <div id="preview"></div>

<script>
    // ğŸ”¥ [í•„ìˆ˜ ìˆ˜ì •] ë³¸ì¸ì˜ Supabase í”„ë¡œì íŠ¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”!
    const SUPABASE_URL = "https://fnasnyvtbifgpmxplkkd.supabase.co"; 
    
    // íŒŒì¼ ê²½ë¡œ (Storage -> configs -> list.json)
    const LIST_URL = `${SUPABASE_URL}/storage/v1/object/public/configs/list.json`;
    
    let uiData = { groups: [] };

    // 1. ì‹œì‘í•˜ë©´ í˜„ì¬ ì €ì¥ëœ list.json íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    async function init() {
        try {
            const res = await fetch(LIST_URL + '?t=' + Date.now());
            if(res.ok) {
                uiData = await res.json();
                render();
            }
        } catch(e) { console.log("ê¸°ì¡´ ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤."); }
    }

    // 2. [ì €ì¥] ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
    async function saveAndSync() {
        const btn = document.getElementById('saveBtn');
        const originalText = btn.innerText;
        btn.innerText = "â³ ì €ì¥ ë° DB ìˆ˜ì§‘ ì¤‘...";
        btn.disabled = true;

        try {
            // [ë‹¨ê³„ A] list.json íŒŒì¼ë¡œ ì €ì¥ (UI ë°°ì¹˜ ì €ì¥)
            await fetch('/api/save_list', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(uiData)
            });

            // [ë‹¨ê³„ B] DB ë™ê¸°í™” ìš”ì²­ (ID ëª©ë¡ì„ ë˜ì ¸ì„œ ë‹‰ë„¤ì„/í”„ì‚¬ ìˆ˜ì§‘ ì‹œí‚´)
            let allMembers = [];
            uiData.groups.forEach(g => allMembers.push(...g.members));
            
            await fetch('/api/sync', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: allMembers })
            });

            alert("âœ… ì €ì¥ ì™„ë£Œ!\n1. í™”ë©´ ë°°ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n2. DBê°€ ìµœì‹  í”„ë¡œí•„ ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.");

        } catch(e) { 
            alert("âŒ ì—ëŸ¬ ë°œìƒ: " + e.message); 
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    // --- í™”ë©´ ê·¸ë¦¬ê¸° (ë Œë”ë§) ---
    function render() {
        const div = document.getElementById('preview');
        const sel = document.getElementById('targetG');
        div.innerHTML = ''; sel.innerHTML = '';

        uiData.groups.forEach((g, i) => {
            // ê·¸ë£¹ ì„ íƒ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
            sel.innerHTML += `<option value="${i}">${g.name}</option>`;
            
            // ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ HTML ìƒì„±
            let mHtml = g.members.map((m, mi) => 
                `<div class="member-row">
                    <span>
                        <span class="badge ${m.platform}">${m.platform==='chzzk'?'C':'S'}</span>
                        <b>${m.id}</b>
                    </span>
                    <button onclick="delMem(${i},${mi})" style="background:#ff7675; color:white; font-size:0.8rem; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">X</button>
                </div>`
            ).join('');
            
            // ê·¸ë£¹ ë°•ìŠ¤ HTML ìƒì„±
            div.innerHTML += `
                <div class="group-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h3 style="margin:0">${g.name}</h3>
                        <button onclick="delGrp(${i})" style="background:#d63031; color:white; font-size:0.8rem; border:none; padding:5px; border-radius:4px; cursor:pointer;">ê·¸ë£¹ì‚­ì œ</button>
                    </div>
                    ${mHtml}
                </div>`;
        });
    }

    // --- ë°ì´í„° ì¡°ì‘ (ë©”ëª¨ë¦¬ ìƒì—ì„œë§Œ ìˆ˜ì •) ---
    function addGroup() { 
        const n = document.getElementById('gName').value;
        if(!n) return;
        uiData.groups.push({ name: n, members: [] }); 
        document.getElementById('gName').value=''; render(); 
    }
    
    function addMember() { 
        const id = document.getElementById('mId').value;
        if(!id) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        
        // ë‹‰ë„¤ì„ ì…ë ¥ì¹¸ ì—†ìŒ! IDë‘ í”Œë«í¼ë§Œ ì €ì¥í•¨.
        uiData.groups[document.getElementById('targetG').value].members.push({
            id: id,
            platform: document.getElementById('pf').value
        }); 
        document.getElementById('mId').value = ''; render(); 
    }
    
    function delMem(g, m) { uiData.groups[g].members.splice(m, 1); render(); }
    function delGrp(g) { uiData.groups.splice(g, 1); render(); }

    init();
</script>
</body>
</html>
