<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>UI ë°°ì¹˜ ê´€ë¦¬ì</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: sans-serif; max-width: 800px; margin: 0 auto; }
        .btn-save { width: 100%; background: #00cec9; font-weight: bold; font-size: 1.2rem; cursor: pointer; padding: 15px; border: none; margin-bottom: 20px; border-radius: 8px; }
        input, select, button { padding: 10px; margin: 5px; border-radius: 5px; border: none; }
        input { background: #444; color: white; border: 1px solid #555; }
        .group-box { background: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #444; }
        .member-row { background: #444; padding: 8px 10px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #555; }
        .badge { padding: 3px 6px; border-radius: 3px; font-size: 0.8rem; margin-right: 5px; color: #000; font-weight: bold; }
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
    </style>
</head>
<body>
    <h2 style="text-align:center">ğŸ› ï¸ UI ë°°ì¹˜ ê´€ë¦¬ (IDë§Œ ì…ë ¥)</h2>
    
    <button onclick="saveAndSync()" class="btn-save" id="saveBtn">ğŸ’¾ ë°°ì¹˜ ì €ì¥ + DB ë™ê¸°í™”</button>

    <div style="text-align:center; background:#111; padding:15px; margin-bottom:20px; border-radius:10px;">
        <input type="text" id="gName" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„">
        <button onclick="addGroup()" style="background:#6c5ce7; color:white">ê·¸ë£¹ ìƒì„±</button>
        <hr style="border-color:#333; margin:15px 0;">
        
        <select id="pf">
            <option value="soop">ğŸŒ² ìˆ²</option>
            <option value="chzzk">âš¡ ì¹˜ì§€ì§</option>
        </select>
        <input type="text" id="mId" placeholder="ì•„ì´ë”” (UID)">
        <select id="targetG"></select>
        <button onclick="addMember()" style="background:#0984e3; color:white">ë©¤ë²„ ì¶”ê°€</button>
    </div>

    <div id="preview"></div>

<script>
    // ğŸ”¥ ë³¸ì¸ Supabase ì£¼ì†Œ í™•ì¸
    const SUPABASE_URL = "https://fnasnyvtbifgpmxplkkd.supabase.co"; 
    const LIST_URL = `${SUPABASE_URL}/storage/v1/object/public/configs/list.json`;
    
    let uiData = { groups: [] };

    async function init() {
        try {
            const res = await fetch(LIST_URL + '?t=' + Date.now());
            if(res.ok) uiData = await res.json();
            render();
        } catch(e) {}
    }

    async function saveAndSync() {
        const btn = document.getElementById('saveBtn');
        btn.innerText = "â³ ì €ì¥ ë° DB ìˆ˜ì§‘ ìš”ì²­ ì¤‘...";
        btn.disabled = true;

        try {
            // 1. ë°°ì¹˜ íŒŒì¼(list.json) ì €ì¥ (IDë‘ ê·¸ë£¹ì •ë³´ë§Œ ìˆìŒ)
            await fetch('/api/save_list', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(uiData)
            });

            // 2. DB ë™ê¸°í™” ìš”ì²­ (ID ë˜ì ¸ì£¼ë©´ ì„œë²„ê°€ ë‹‰ë„¤ì„/í”„ì‚¬ ê¸ì–´ì˜´)
            let allMembers = [];
            uiData.groups.forEach(g => allMembers.push(...g.members));
            
            await fetch('/api/sync', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: allMembers })
            });

            alert("âœ… ì™„ë£Œ!\në°°ì¹˜ë„ê°€ ì €ì¥ë˜ì—ˆê³ , DBê°€ ìµœì‹  ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.");
        } catch(e) { 
            alert("ì—ëŸ¬: " + e.message); 
        } finally {
            btn.innerText = "ğŸ’¾ ë°°ì¹˜ ì €ì¥ + DB ë™ê¸°í™”";
            btn.disabled = false;
        }
    }

    function render() {
        const div = document.getElementById('preview');
        const sel = document.getElementById('targetG');
        div.innerHTML = ''; sel.innerHTML = '';

        uiData.groups.forEach((g, i) => {
            sel.innerHTML += `<option value="${i}">${g.name}</option>`;
            
            let mHtml = g.members.map((m, mi) => 
                `<div class="member-row">
                    <span>
                        <span class="badge ${m.platform}">${m.platform==='chzzk'?'C':'S'}</span>
                        ${m.id}
                    </span>
                    <button onclick="delMem(${i},${mi})" style="background:#ff7675; color:white; font-size:0.8rem">X</button>
                </div>`
            ).join('');
            
            div.innerHTML += `
                <div class="group-box">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h3 style="margin:0">${g.name}</h3>
                        <button onclick="delGrp(${i})" style="background:#d63031; color:white; font-size:0.8rem">ê·¸ë£¹ì‚­ì œ</button>
                    </div>
                    ${mHtml}
                </div>`;
        });
    }

    function addGroup() { 
        const n = document.getElementById('gName').value;
        if(!n) return;
        uiData.groups.push({ name: n, members: [] }); 
        document.getElementById('gName').value=''; render(); 
    }
    
    function addMember() { 
        const id = document.getElementById('mId').value;
        if(!id) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        
        // ë‹‰ë„¤ì„ ì €ì¥ ì•ˆ í•¨. IDë‘ í”Œë«í¼ë§Œ ì €ì¥.
        uiData.groups[document.getElementById('targetG').value].members.push({
            id: id,
            platform: document.getElementById('pf').value
        }); 
        document.getElementById('mId').value = ''; render(); 
    }
    
    function delMem(g, m) { uiData.groups[g].members.splice(m, 1); render(); }
    function delGrp(g) { uiData.groups.splice(g, 1); render(); }

    init();
</script>
</body>
</html>
