<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DB ê´€ë¦¬ì</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: sans-serif; max-width: 900px; margin: 0 auto; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 10px 15px; margin: 5px; }
        input, select { padding: 10px; background: #444; border: 1px solid #555; color: white; border-radius: 5px; }
        .list-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .list-table th { background: #444; padding: 10px; text-align: left; }
        .list-table td { border-bottom: 1px solid #555; padding: 10px; }
        .badge { padding: 3px 6px; border-radius: 3px; font-size: 0.8rem; font-weight: bold; color:black; }
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
    </style>
</head>
<body>

    <h2 style="text-align:center">ğŸ› ï¸ ìŠ¤íŠ¸ë¦¬ë¨¸ DB ê´€ë¦¬</h2>

    <div style="background: #333; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;">
        <h3>â• ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡ / ê·¸ë£¹ ìˆ˜ì •</h3>
        
        <select id="pf">
            <option value="soop">ğŸŒ² ìˆ² (SOOP)</option>
            <option value="chzzk">âš¡ ì¹˜ì§€ì§ (CHZZK)</option>
        </select>
        <input type="text" id="mId" placeholder="ìŠ¤íŠ¸ë¦¬ë¨¸ ID (UID)">
        
        <input type="text" id="gName" placeholder="ê·¸ë£¹ëª… (ì˜ˆ: ì™íƒ€ë²„ìŠ¤)" list="groupList">
        <datalist id="groupList"></datalist>

        <button onclick="saveStreamer()" style="background:#0984e3; color:white">ğŸ’¾ ì €ì¥ (DBë“±ë¡ + ì •ë³´ìˆ˜ì§‘)</button>
    </div>

    <h3>ğŸ“‹ ë“±ë¡ëœ ëª©ë¡ (<span id="totalCnt">0</span>ëª…)</h3>
    <button onclick="updateAll()" style="background:#e17055; color:white;">âš¡ ì „ì²´ ì •ë³´ ê°±ì‹  (ì˜¤ë˜ ê±¸ë¦¼)</button>
    
    <table class="list-table">
        <thead>
            <tr>
                <th>ê·¸ë£¹</th>
                <th>í”Œë«í¼</th>
                <th>ID</th>
                <th>ë‹‰ë„¤ì„</th>
                <th>ì‚­ì œ</th>
            </tr>
        </thead>
        <tbody id="listBody"></tbody>
    </table>

<script>
    let currentList = [];

    // 1. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (api/get_list.js ì‚¬ìš©)
    async function loadList() {
        const res = await fetch('/api/get_list'); 
        const data = await res.json();
        currentList = data;
        
        const tbody = document.getElementById('listBody');
        const dlist = document.getElementById('groupList');
        document.getElementById('totalCnt').innerText = data.length;
        tbody.innerHTML = '';
        dlist.innerHTML = '';

        // ê·¸ë£¹ëª… ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ ìƒì„±
        const groups = [...new Set(data.map(d => d.group_name).filter(Boolean))];
        groups.forEach(g => dlist.innerHTML += `<option value="${g}">`);

        // ê·¸ë£¹ë³„ ì •ë ¬
        data.sort((a,b) => (a.group_name || 'zz').localeCompare(b.group_name || 'zz'));

        data.forEach(m => {
            const pfClass = m.platform === 'chzzk' ? 'chzzk' : 'soop';
            tbody.innerHTML += `
                <tr>
                    <td style="color:#fdcb6e; font-weight:bold">${m.group_name || 'ë¯¸ë¶„ë¥˜'}</td>
                    <td><span class="badge ${pfClass}">${m.platform}</span></td>
                    <td>${m.id}</td>
                    <td>${m.nickname || '-'}</td>
                    <td><button onclick="alert('DB ì‚­ì œ API í•„ìš”')" style="background:#d63031; color:white; font-size:0.8rem;">ì‚­ì œ</button></td>
                </tr>
            `;
        });
    }

    // 2. ì €ì¥/ìˆ˜ì • (api/sync.js ì‚¬ìš©)
    async function saveStreamer() {
        const id = document.getElementById('mId').value;
        const pf = document.getElementById('pf').value;
        const group = document.getElementById('gName').value;

        if(!id || !group) return alert("ì•„ì´ë””ì™€ ê·¸ë£¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.");

        const btn = document.querySelector('button[onclick="saveStreamer()"]');
        btn.innerText = "â³ ì €ì¥ ì¤‘...";
        
        // sync APIì— 'ê·¸ë£¹ëª…'ê¹Œì§€ ë‹´ì•„ì„œ ë³´ëƒ„ -> DBì— ê·¸ë£¹ëª… ì €ì¥ë¨ + í¬ë¡¤ë§ ì‹¤í–‰ë¨
        await fetch('/api/sync', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items: [{ id, platform: pf, group_name: group }] })
        });

        alert("âœ… ì €ì¥ ì™„ë£Œ!");
        document.getElementById('mId').value = '';
        btn.innerText = "ğŸ’¾ ì €ì¥ (DBë“±ë¡ + ì •ë³´ìˆ˜ì§‘)";
        loadList();
    }

    // 3. ì „ì²´ ê°±ì‹  (api/sync.js ì¬í™œìš©)
    async function updateAll() {
        if(!confirm("ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë¨¸ì˜ ì •ë³´ë¥¼ ìƒˆë¡œ ê¸ì–´ì˜µë‹ˆê¹Œ?")) return;
        
        // í˜„ì¬ ëª©ë¡ì— ìˆëŠ” IDë“¤ë§Œ ì¶”ë ¤ì„œ ë³´ëƒ„ (ê·¸ë£¹ëª…ì€ ìœ ì§€í•´ì•¼ í•˜ë‹ˆ ê°™ì´ ë³´ëƒ„)
        const items = currentList.map(m => ({ 
            id: m.id, 
            platform: m.platform, 
            group_name: m.group_name // ì´ê±° ì•ˆ ë³´ë‚´ë©´ ê·¸ë£¹ëª… ë‚ ì•„ê°ˆ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ì£¼ì˜ 
        }));

        await fetch('/api/sync', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items })
        });
        
        alert("âœ… ì „ì²´ ê°±ì‹  ì™„ë£Œ");
        loadList();
    }

    loadList();
</script>
</body>
</html>
