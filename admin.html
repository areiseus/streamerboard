<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - Streamer Board</title>
    <style>
        :root { --primary: #42C769; --secondary: #3b82f6; --chzzk: #00E59D; --bg: #333; --text: #2f3542; }
        body { margin: 0; background: var(--bg); font-family: 'Pretendard', sans-serif; color: var(--text); }
        .container { max-width: 1000px; margin: 40px auto; background: #f0f2f5; padding: 40px; border-radius: 20px; min-height: 80vh; }
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
        
        #admin-panel { background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; border: 2px solid var(--primary); }
        .admin-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; align-items: center; padding: 10px; }
        
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { opacity: 0.9; }
        
        /* íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .sync-panel { background-color: #e3fcf0; border: 1px solid #42C769; margin-bottom: 10px; border-radius: 10px; }
        .history-panel { background-color: #e0f2fe; border: 1px solid #3b82f6; margin-bottom: 20px; border-radius: 10px; }

        .group-section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .group-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .group-title { font-size: 1.2rem; font-weight: bold; }

        .list-item { display: inline-flex; align-items: center; background: #eee; padding: 5px 12px; border-radius: 20px; margin: 5px; font-size: 0.9rem; gap: 6px; }
        .p-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; }
        .p-soop { background-color: #42C769; }
        .p-chzzk { background-color: #1e1e1e; color: #00E59D; }
        .del-x { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; }
        
        .alert-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>âš™ï¸ í†µí•© ê´€ë¦¬ì (SOOP + CHZZK)</h1>
        <p>ì„¤ì • ë³€ê²½ í›„ ë°˜ë“œì‹œ <b>[JSON ë‹¤ìš´ë¡œë“œ]</b>í•˜ì—¬ GitHubì— ë°˜ì˜í•´ì£¼ì„¸ìš”.</p>
        <button style="background:#666" onclick="location.href='index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ</button>
    </header>

    <div class="alert-box">
        âš ï¸ <b>ì¤‘ìš”:</b> ìˆ˜ì • í›„ [ğŸ’¾ list.json ë‹¤ìš´ë¡œë“œ] -> GitHub íŒŒì¼ êµì²´ í•„ìˆ˜!
        <br><br>
        <button onclick="downloadJson()">ğŸ’¾ list.json ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="admin-panel">
        <div class="admin-row sync-panel">
            <h3>ğŸ”„ ê¸°ë³¸ ì •ë³´ ë™ê¸°í™”</h3>
            <p style="font-size:0.9rem; color:#006266; margin: 0 15px;">ë‹‰ë„¤ì„, í”„ì‚¬ ë“± ê¸°ë³¸ ì •ë³´ë¥¼<br>ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
            <button onclick="triggerSync()" id="sync-btn">âš¡ í”„ë¡œí•„ ê°±ì‹ </button>
        </div>

        <div class="admin-row history-panel">
            <h3>ğŸ“… ì¼ì¼ ê¸°ë¡ ìˆ˜ì§‘</h3>
            <p style="font-size:0.9rem; color:#1e40af; margin: 0 15px;">ì–´ì œ ë°©ì†¡ ê¸°ë¡ê³¼ ì• ì²­ì ìˆ˜ë¥¼<br>ìˆ˜ì§‘í•˜ì—¬ DBì— ì €ì¥í•©ë‹ˆë‹¤.</p>
            <button onclick="triggerHistory()" id="hist-btn" style="background:var(--secondary)">ğŸ“Š ê¸°ë¡ ìˆ˜ì§‘ ì‹œì‘</button>
        </div>

        <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">

        <div class="admin-row">
            <h3>ğŸ“‚ ê·¸ë£¹ ê´€ë¦¬</h3>
            <input type="text" id="new-group-name" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„">
            <button onclick="addNewGroup()">ìƒì„±</button>
        </div>
        
        <div class="admin-row">
            <h3>â• ë©¤ë²„ ì¶”ê°€</h3>
            <select id="new-platform">
                <option value="soop">ğŸŒ² SOOP (ìˆ²)</option>
                <option value="chzzk">âš¡ CHZZK (ì¹˜ì§€ì§)</option>
            </select>
            <input type="text" id="new-streamer-id" placeholder="ID (ì¹˜ì§€ì§ì€ ê³ ìœ UID)" style="width:200px;">
            <select id="group-select"></select>
            <button onclick="addStreamer()">ì¶”ê°€</button>
        </div>
    </div>

    <div id="preview-list"></div>
</div>

<script>
    let dashboardData = { groups: [], ungrouped: [] };
    let ADMIN_PASSWORD = "1234";

    async function init() {
        try {
            const confRes = await fetch('admin.json?t=' + Date.now());
            if(confRes.ok) { const conf = await confRes.json(); ADMIN_PASSWORD = conf.password; }
        } catch(e) {}

        let pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:");
        if(pw !== ADMIN_PASSWORD) { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); location.href='index.html'; return; }

        const localData = localStorage.getItem('myStreamerData');
        if (localData) dashboardData = JSON.parse(localData);
        else {
            try {
                const res = await fetch('list.json?t=' + Date.now());
                if(res.ok) dashboardData = await res.json();
            } catch(e) {}
        }
        migrateData();
        renderManager();
    }

    function migrateData() {
        const convert = (list) => list.map(item => {
            return typeof item === 'string' ? { id: item, platform: 'soop' } : item;
        });
        dashboardData.groups.forEach(g => { g.members = convert(g.members); });
        dashboardData.ungrouped = convert(dashboardData.ungrouped);
    }

    function getAllMembers() {
        const allItems = [];
        const pushMembers = (list) => list.forEach(m => {
            if(!allItems.find(x => x.id === m.id)) allItems.push(m);
        });
        dashboardData.groups.forEach(g => pushMembers(g.members));
        pushMembers(dashboardData.ungrouped);
        return allItems;
    }

    // ê¸°ëŠ¥ 1. í”„ë¡œí•„ ë™ê¸°í™”
    async function triggerSync() {
        const btn = document.getElementById('sync-btn');
        const allItems = getAllMembers();
        if(allItems.length === 0) return alert("ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        if(!confirm(`ì´ ${allItems.length}ëª…ì˜ í”„ë¡œí•„ì„ ê°±ì‹ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        btn.innerText = "â³ ì§„í–‰ ì¤‘..."; btn.disabled = true;
        try {
            const res = await fetch('/api/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: allItems })
            });
            const result = await res.json();
            if(res.ok) alert(`âœ… ì™„ë£Œ!`);
            else alert("âŒ ì˜¤ë¥˜: " + result.error);
        } catch (e) { alert("âŒ í†µì‹  ì˜¤ë¥˜"); } 
        finally { btn.innerText = "âš¡ í”„ë¡œí•„ ê°±ì‹ "; btn.disabled = false; }
    }

    // ê¸°ëŠ¥ 2. ê¸°ë¡ ìˆ˜ì§‘
    async function triggerHistory() {
        const btn = document.getElementById('hist-btn');
        const allItems = getAllMembers();
        if(allItems.length === 0) return alert("ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.");
        
        const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
        const targetDate = prompt("ìˆ˜ì§‘í•  ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD)\n(ê¸°ë³¸ê°’: ì–´ì œ)", yesterday);
        if(!targetDate) return;

        btn.innerText = "â³ ìˆ˜ì§‘ ì¤‘..."; btn.disabled = true;
        try {
            const res = await fetch('/api/history', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: allItems, date: targetDate })
            });
            const result = await res.json();
            if(res.ok) {
                alert(`âœ… ìˆ˜ì§‘ ì™„ë£Œ!\nì„±ê³µ: ${result.results.filter(r=>r.status==='success').length}ëª…`);
                console.log(result);
            } else alert("âŒ ì˜¤ë¥˜: " + result.error);
        } catch (e) { alert("âŒ í†µì‹  ì˜¤ë¥˜"); } 
        finally { btn.innerText = "ğŸ“Š ê¸°ë¡ ìˆ˜ì§‘ ì‹œì‘"; btn.disabled = false; }
    }

    function renderManager() {
        const container = document.getElementById('preview-list');
        container.innerHTML = '';

        const createMemberTag = (member, gid) => {
            const m = typeof member === 'string' ? { id: member, platform: 'soop' } : member;
            const badgeClass = m.platform === 'chzzk' ? 'p-chzzk' : 'p-soop';
            const badgeName = m.platform === 'chzzk' ? 'CHZZK' : 'SOOP';
            return `<div class="list-item"><span class="p-badge ${badgeClass}">${badgeName}</span><span>${m.id}</span><span class="del-x" onclick="removeMember('${m.id}', '${gid}')">X</span></div>`;
        };

        dashboardData.groups.forEach((group, index) => {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `
                <div class="group-header">
                    <span class="group-title">${group.name}</span>
                    <div>
                        <button class="secondary" onclick="renameGroup(${index})">ì´ë¦„ë³€ê²½</button>
                        <button class="secondary" onclick="moveGroup(${index}, -1)">â–²</button>
                        <button class="secondary" onclick="moveGroup(${index}, 1)">â–¼</button>
                        <button class="danger" onclick="deleteGroup(${index})">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="members-area"></div>
            `;
            const memArea = section.querySelector('.members-area');
            if(group.members.length === 0) memArea.innerHTML = '<span style="color:#aaa">ë©¤ë²„ ì—†ìŒ</span>';
            else group.members.forEach(m => memArea.innerHTML += createMemberTag(m, group.id));
            container.appendChild(section);
        });

        if(dashboardData.ungrouped.length > 0) {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `<div class="group-header"><span class="group-title">ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)</span></div><div class="members-area"></div>`;
            const memArea = section.querySelector('.members-area');
            dashboardData.ungrouped.forEach(m => memArea.innerHTML += createMemberTag(m, 'ungrouped'));
            container.appendChild(section);
        }
        updateSelectBox();
    }

    function saveData() { localStorage.setItem('myStreamerData', JSON.stringify(dashboardData)); renderManager(); }
    function addNewGroup() { const name = document.getElementById('new-group-name').value; if(!name) return; dashboardData.groups.push({ id: 'g_'+Date.now(), name: name, members: [] }); document.getElementById('new-group-name').value = ''; saveData(); }
    function addStreamer() {
        const id = document.getElementById('new-streamer-id').value.trim();
        const platform = document.getElementById('new-platform').value;
        const gid = document.getElementById('group-select').value;
        if(!id) return alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”");
        const newItem = { id: id, platform: platform }; 
        if(gid === 'ungrouped') dashboardData.ungrouped.push(newItem);
        else { const g = dashboardData.groups.find(x => x.id === gid); if(g) g.members.push(newItem); }
        document.getElementById('new-streamer-id').value = '';
        saveData();
    }
    function removeMember(id, gid) { if(!confirm("ì‚­ì œ?")) return; const filterFn = (m) => (typeof m === 'string' ? m : m.id) !== id; if(gid === 'ungrouped') dashboardData.ungrouped = dashboardData.ungrouped.filter(filterFn); else { const g = dashboardData.groups.find(x => x.id === gid); if(g) g.members = g.members.filter(filterFn); } saveData(); }
    function renameGroup(idx) { const n = prompt("ìƒˆ ì´ë¦„:", dashboardData.groups[idx].name); if(n) { dashboardData.groups[idx].name = n; saveData(); } }
    function deleteGroup(idx) { if(!confirm("ì‚­ì œ?")) return; dashboardData.ungrouped.push(...dashboardData.groups[idx].members); dashboardData.groups.splice(idx, 1); saveData(); }
    function moveGroup(idx, dir) { const n = idx + dir; if(n < 0 || n >= dashboardData.groups.length) return; [dashboardData.groups[idx], dashboardData.groups[n]] = [dashboardData.groups[n], dashboardData.groups[idx]]; saveData(); }
    function updateSelectBox() { const sel = document.getElementById('group-select'); sel.innerHTML = ''; dashboardData.groups.forEach(g => sel.innerHTML += `<option value="${g.id}">${g.name}</option>`); sel.innerHTML += `<option value="ungrouped">ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)</option>`; }
    function downloadJson() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dashboardData, null, 2)); a.download = "list.json"; document.body.appendChild(a); a.click(); a.remove(); alert("ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ë¡œ GitHub list.jsonì„ êµì²´í•˜ì„¸ìš”!"); }
    init();
</script>

</body>
</html>
