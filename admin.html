<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - Streamer Board</title>
    <style>
        :root { --primary: #42C769; --bg: #333; --card: #ffffff; --text: #2f3542; }
        body { margin: 0; background: var(--bg); font-family: 'Pretendard', sans-serif; color: var(--text); }
        
        .container { max-width: 1000px; margin: 40px auto; background: #f0f2f5; padding: 40px; border-radius: 20px; min-height: 80vh; }
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #ddd; padding-bottom: 20px; }
        header h1 { margin: 0; font-size: 2rem; }
        
        /* ê´€ë¦¬ì íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        #admin-panel { background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border: 2px solid var(--primary); }
        .admin-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; align-items: center; padding: 10px; border-radius: 8px;}
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        button { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: scale(1.02); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.danger { background: #ff4757; }
        button.secondary { background: #57606f; }
        
        /* ë™ê¸°í™” íŒ¨ë„ (ê°•ì¡°) */
        .sync-panel { background-color: #e3fcf0; border: 1px solid #42C769; }

        .group-section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .group-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; }
        .group-title { font-size: 1.2rem; font-weight: bold; }
        
        .list-item { display: inline-block; background: #eee; padding: 5px 10px; border-radius: 20px; margin: 5px; font-size: 0.9rem; }
        .del-x { color: red; cursor: pointer; font-weight: bold; margin-left: 5px; }

        .alert-box { background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>âš™ï¸ Streamer Board ê´€ë¦¬ì</h1>
        <p>ì„¤ì •ì„ ë³€ê²½í•œ í›„ì—ëŠ” ë°˜ë“œì‹œ <b>[JSON ë‹¤ìš´ë¡œë“œ]</b>í•˜ì—¬ GitHubì— ì˜¬ë ¤ì£¼ì„¸ìš”.</p>
        <button class="secondary" onclick="location.href='index.html'">ğŸ  ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </header>

    <div class="alert-box">
        âš ï¸ <b>ì¤‘ìš”:</b> ìˆ˜ì •ì„ ë§ˆì¹˜ë©´ [ğŸ’¾ list.json ë‹¤ìš´ë¡œë“œ]ë¥¼ ëˆŒëŸ¬ íŒŒì¼ì„ ë°›ê³ ,<br>
        GitHubì˜ <b>list.json</b> ë‚´ìš©ì„ êµì²´í•´ì•¼ í•©ë‹ˆë‹¤.
        <br><br>
        <button onclick="downloadJson()">ğŸ’¾ list.json ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <div id="admin-panel">
        <div class="admin-row sync-panel">
            <h3>ğŸ”„ ì„œë²„ ë°ì´í„° ë™ê¸°í™”</h3>
            <p style="font-size:0.9rem; color:#006266; margin: 0 15px;">
                ë“±ë¡ëœ ëª¨ë“  ìŠ¤íŠ¸ë¦¬ë¨¸ì˜ ìµœì‹  ì •ë³´(ë‹‰ë„¤ì„, í”„ì‚¬)ë¥¼<br>ìˆ²(SOOP)ì—ì„œ ê°€ì ¸ì™€ <b>DBì— ì €ì¥</b>í•©ë‹ˆë‹¤.
            </p>
            <button onclick="triggerSync()" id="sync-btn">âš¡ ëª¨ë‘ ê°±ì‹  (DB ì €ì¥)</button>
        </div>
        <hr style="border:0; border-top:1px dashed #ddd; margin: 20px 0;">

        <div class="admin-row">
            <h3>ğŸ“‚ ê·¸ë£¹ ì¶”ê°€</h3>
            <input type="text" id="new-group-name" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„">
            <button onclick="addNewGroup()">ìƒì„±</button>
        </div>
        <div class="admin-row">
            <h3>â• ë©¤ë²„ ì¶”ê°€</h3>
            <input type="text" id="new-streamer-id" placeholder="BJ ì•„ì´ë””">
            <select id="group-select"></select>
            <button onclick="addStreamer()">ì¶”ê°€</button>
        </div>
    </div>

    <div id="preview-list"></div>
</div>

<script>
    let dashboardData = { groups: [], ungrouped: [] };
    let ADMIN_PASSWORD = "1234";

    // 1. ì´ˆê¸°í™”
    async function init() {
        try {
            const confRes = await fetch('admin.json?t=' + Date.now());
            if(confRes.ok) { const conf = await confRes.json(); ADMIN_PASSWORD = conf.password; }
        } catch(e) {}

        let pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(pw !== ADMIN_PASSWORD) {
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤. ë©”ì¸ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
            location.href = 'index.html';
            return;
        }

        const localData = localStorage.getItem('myStreamerData');
        if (localData) {
            dashboardData = JSON.parse(localData);
        } else {
            try {
                const res = await fetch('list.json?t=' + Date.now());
                if(res.ok) dashboardData = await res.json();
            } catch(e) {}
        }
        renderManager();
    }

    // 2. [í•µì‹¬ ê¸°ëŠ¥] DB ë™ê¸°í™” ìš”ì²­
    async function triggerSync() {
        const btn = document.getElementById('sync-btn');
        
        // ID ëª©ë¡ ì¶”ì¶œ
        const allIds = new Set();
        dashboardData.groups.forEach(g => g.members.forEach(id => allIds.add(id)));
        dashboardData.ungrouped.forEach(id => allIds.add(id));
        
        if(allIds.size === 0) return alert("ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.");

        if(!confirm(`ì´ ${allIds.size}ëª…ì˜ ë°ì´í„°ë¥¼ ìˆ²(SOOP)ì—ì„œ ê°€ì ¸ì™€ DBì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹œê°„ì´ ì¡°ê¸ˆ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;

        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        btn.innerText = "â³ ë™ê¸°í™” ì§„í–‰ ì¤‘...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/sync', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: Array.from(allIds) })
            });
            
            const result = await res.json();

            if(res.ok) {
                alert(`âœ… ë™ê¸°í™” ì™„ë£Œ!\n- ì„±ê³µ: ${result.results.filter(r=>r.status==='success').length}ëª…\n- ì‹¤íŒ¨: ${result.results.filter(r=>r.status==='failed').length}ëª…`);
                console.log("Sync Result:", result);
            } else {
                alert("âŒ ì˜¤ë¥˜ ë°œìƒ: " + result.error);
            }

        } catch (error) {
            console.error(error);
            alert("âŒ ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            // ë²„íŠ¼ ë³µêµ¬
            btn.innerText = "âš¡ ëª¨ë‘ ê°±ì‹  (DB ì €ì¥)";
            btn.disabled = false;
        }
    }

    // --- ê¸°ì¡´ UI ë¡œì§ë“¤ (ìœ ì§€) ---
    function renderManager() {
        const container = document.getElementById('preview-list');
        container.innerHTML = '';

        dashboardData.groups.forEach((group, index) => {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `
                <div class="group-header">
                    <span class="group-title">${group.name}</span>
                    <div>
                        <button class="secondary" onclick="renameGroup(${index})">ì´ë¦„ë³€ê²½</button>
                        <button class="secondary" onclick="moveGroup(${index}, -1)">â–²</button>
                        <button class="secondary" onclick="moveGroup(${index}, 1)">â–¼</button>
                        <button class="danger" onclick="deleteGroup(${index})">ì‚­ì œ</button>
                    </div>
                </div>
                <div class="members-area"></div>
            `;
            const memArea = section.querySelector('.members-area');
            if(group.members.length === 0) memArea.innerHTML = '<span style="color:#aaa">ë©¤ë²„ ì—†ìŒ</span>';
            else {
                group.members.forEach(id => {
                    memArea.innerHTML += `<div class="list-item"><span>${id}</span> <span class="del-x" onclick="removeMember('${id}', '${group.id}')">X</span></div>`;
                });
            }
            container.appendChild(section);
        });

        if(dashboardData.ungrouped.length > 0) {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `<div class="group-header"><span class="group-title">ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)</span></div><div class="members-area"></div>`;
            const memArea = section.querySelector('.members-area');
            dashboardData.ungrouped.forEach(id => {
                memArea.innerHTML += `<div class="list-item"><span>${id}</span> <span class="del-x" onclick="removeMember('${id}', 'ungrouped')">X</span></div>`;
            });
            container.appendChild(section);
        }
        updateSelectBox();
    }

    function saveData() { localStorage.setItem('myStreamerData', JSON.stringify(dashboardData)); renderManager(); }
    function addNewGroup() { const name = document.getElementById('new-group-name').value; if(!name) return; dashboardData.groups.push({ id: 'g_'+Date.now(), name: name, members: [] }); document.getElementById('new-group-name').value = ''; saveData(); }
    function renameGroup(idx) { const n = prompt("ìƒˆ ì´ë¦„:", dashboardData.groups[idx].name); if(n) { dashboardData.groups[idx].name = n; saveData(); } }
    function deleteGroup(idx) { if(!confirm("ì‚­ì œ?")) return; dashboardData.ungrouped.push(...dashboardData.groups[idx].members); dashboardData.groups.splice(idx, 1); saveData(); }
    function moveGroup(idx, dir) { const n = idx + dir; if(n < 0 || n >= dashboardData.groups.length) return; [dashboardData.groups[idx], dashboardData.groups[n]] = [dashboardData.groups[n], dashboardData.groups[idx]]; saveData(); }
    function addStreamer() { const id = document.getElementById('new-streamer-id').value; const gid = document.getElementById('group-select').value; if(!id) return; if(gid === 'ungrouped') { if(!dashboardData.ungrouped.includes(id)) dashboardData.ungrouped.push(id); } else { const g = dashboardData.groups.find(x => x.id === gid); if(g && !g.members.includes(id)) g.members.push(id); } document.getElementById('new-streamer-id').value = ''; saveData(); }
    function removeMember(id, gid) { if(!confirm("ì‚­ì œ?")) return; if(gid === 'ungrouped') dashboardData.ungrouped = dashboardData.ungrouped.filter(x => x !== id); else { const g = dashboardData.groups.find(x => x.id === gid); if(g) g.members = g.members.filter(x => x !== id); } saveData(); }
    function updateSelectBox() { const sel = document.getElementById('group-select'); sel.innerHTML = ''; dashboardData.groups.forEach(g => sel.innerHTML += `<option value="${g.id}">${g.name}</option>`); sel.innerHTML += `<option value="ungrouped">ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)</option>`; }
    function downloadJson() { const a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dashboardData, null, 2)); a.download = "list.json"; document.body.appendChild(a); a.click(); a.remove(); alert("ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ë¡œ GitHub list.jsonì„ êµì²´í•˜ì„¸ìš”!"); }

    init();
</script>

</body>
</html>
