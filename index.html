<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Board</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #42C769; --bg: #F0F2F5; --card: #ffffff; --text: #2f3542; }
        body { margin: 0; background: var(--bg); font-family: 'Pretendard', -apple-system, sans-serif; color: var(--text); }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; }
        header { text-align: center; margin-bottom: 30px; position: relative; }
        header h1 { color: #333; margin: 0; font-size: 2.5rem; letter-spacing: -1px; }
        
        .admin-btn { position: absolute; top: 0; right: 0; background: white; border: 1px solid #ddd; padding: 6px 12px; border-radius: 20px; cursor: pointer; color: #666; font-size: 0.8rem; font-weight: bold; transition: 0.2s; }
        .admin-btn:hover { background: #333; color: white; border-color: #333; }
        
        /* ê´€ë¦¬ì íŒ¨ë„ */
        #admin-panel { display: none; background: white; padding: 20px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 2px solid var(--primary); }
        .admin-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        button.action-btn { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button.action-btn.secondary { background: #666; }
        
        /* ê·¸ë£¹ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .group-section { margin-bottom: 40px; }
        .group-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .group-title { font-size: 1.4rem; font-weight: bold; color: #333; margin-right: 15px; }
        .group-controls { display: none; gap: 5px; } /* ê´€ë¦¬ìì¼ ë•Œë§Œ ë³´ì„ */
        .group-controls button { font-size: 0.8rem; padding: 3px 8px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background: #fff; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            position: relative; background: var(--card); border-radius: 20px; padding: 25px 15px; text-align: center; 
            cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card.is-live { border-color: #ff4757; background: #fff5f5; }
        
        .delete-btn {
            display: none; position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; background: #ff4757; color: white;
            border-radius: 50%; text-align: center; line-height: 22px; cursor: pointer; z-index: 10;
        }

        .profile-wrapper { position: relative; width: 90px; height: 90px; margin: 0 auto 15px; }
        .card img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #eee; background: #eee;}
        .card.is-live img { border-color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.5); }
        
        .badges { position: absolute; bottom: -5px; width: 100%; text-align: center; display: flex; justify-content: center; gap: 5px; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; color: white; }
        .badge.live { background: #ff4757; display: none; }
        .card.is-live .badge.live { display: inline-block; }
        .badge.multi { background: #5f27cd; display: none; } /* êµì§‘í•© ë±ƒì§€ */
        
        .status-text { font-size: 0.85rem; color: #888; margin-top: 5px;}
        .card.is-live .status-text { color: #ff4757; font-weight: bold; }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(3px); }
        .modal-content { background: white; margin: 5vh auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }
        .close-btn { float: right; font-size: 2rem; cursor: pointer; color: #999; }
        
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 20px; }
        .cal-day { aspect-ratio: 1; border: 1px solid #f0f0f0; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.9rem; }
        .cal-day.has-vod { background-color: #e3fcf0; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .chart-box { margin-top: 30px; height: 250px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Streamer Board</h1>
        <p>ì‹¤ì‹œê°„ ë°©ì†¡ í˜„í™© (ê·¸ë£¹ ê´€ë¦¬ ver)</p>
        <button class="admin-btn" onclick="toggleAdmin()">âš™ï¸ ì„¤ì •</button>
    </header>

    <div id="admin-panel">
        <div class="admin-row">
            <h3>ğŸ“‚ ê·¸ë£¹ ê´€ë¦¬</h3>
            <input type="text" id="new-group-name" placeholder="ìƒˆ ê·¸ë£¹ ì´ë¦„">
            <button class="action-btn" onclick="addNewGroup()">ê·¸ë£¹ ìƒì„±</button>
        </div>
        <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ddd;">
        <div class="admin-row">
            <h3>â• ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€</h3>
            <input type="text" id="new-streamer-id" placeholder="BJ ì•„ì´ë”” (ì˜ˆ: woowakgood)">
            <select id="group-select">
                </select>
            <button class="action-btn" onclick="addStreamer()">ì¶”ê°€</button>
        </div>
        <p style="font-size:0.8rem; color:#888; text-align: center;">* ì—¬ëŸ¬ ê·¸ë£¹ì— ê°™ì€ ì‚¬ëŒì„ ì¶”ê°€í•˜ë©´ 'êµì§‘í•©'ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>

    <div id="dashboard-content"></div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <h2 id="modal-title">ë°©ì†¡ ê¸°ë¡</h2>
        <div class="calendar" id="calendar-grid"></div>
        <div class="chart-box"><canvas id="timeChart"></canvas></div>
    </div>
</div>

<script>
    const ADMIN_PASSWORD = "1234"; // ğŸ” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸
    let isAdmin = false;
    let dashboardData = {
        groups: [
            { id: 'g_main', name: 'ğŸ‘‘ ë©”ì¸ ê·¸ë£¹', members: [] },
            { id: 'g_game', name: 'ğŸ® ê²Œì„ ë©¤ë²„', members: [] }
        ],
        ungrouped: ['bluejin0129', 'moonightwmn'] // ê¸°ë³¸ ë©¤ë²„
    };

    // 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸°í™”)
    function init() {
        const saved = localStorage.getItem('myStreamerData');
        if (saved) {
            dashboardData = JSON.parse(saved);
        }
        renderDashboard();
    }

    // 2. ë°ì´í„° ì €ì¥
    function saveData() {
        localStorage.setItem('myStreamerData', JSON.stringify(dashboardData));
        renderDashboard();
    }

    // 3. ì „ì²´ í™”ë©´ ê·¸ë¦¬ê¸° (í•µì‹¬ ë¡œì§)
    function renderDashboard() {
        const container = document.getElementById('dashboard-content');
        container.innerHTML = ''; // ì‹¹ ë¹„ìš°ê¸°
        
        // 3-1. ê·¸ë£¹ ë Œë”ë§
        dashboardData.groups.forEach((group, index) => {
            const section = createGroupSection(group, index);
            container.appendChild(section);
        });

        // 3-2. ê·¸ë£¹ ì—†ëŠ” ë¦¬ìŠ¤íŠ¸ (ë§¨ ì•„ë˜)
        if (dashboardData.ungrouped.length > 0) {
            const ungroupedSection = createGroupSection({ id: 'g_ungrouped', name: 'ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)', members: dashboardData.ungrouped }, -1);
            container.appendChild(ungroupedSection);
        }

        // 3-3. ê´€ë¦¬ì ëª¨ë“œ UI ê°±ì‹ 
        updateAdminUI();
    }

    // ê·¸ë£¹ ì„¹ì…˜ HTML ìƒì„±
    function createGroupSection(group, index) {
        const section = document.createElement('div');
        section.className = 'group-section';
        
        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ìœ„, ì•„ë˜, ì‚­ì œ)
        let controls = '';
        if (index !== -1) { // ë¯¸ë¶„ë¥˜ ê·¸ë£¹ì´ ì•„ë‹ˆë©´
            controls = `
                <div class="group-controls" style="display:${isAdmin ? 'flex' : 'none'}">
                    <button onclick="moveGroup(${index}, -1)">â–²</button>
                    <button onclick="moveGroup(${index}, 1)">â–¼</button>
                    <button onclick="deleteGroup(${index})" style="color:red;">ì‚­ì œ</button>
                </div>
            `;
        }

        section.innerHTML = `
            <div class="group-header">
                <span class="group-title">${group.name}</span>
                ${controls}
            </div>
            <div class="grid" id="grid-${group.id}"></div>
        `;

        // ë©¤ë²„ ì¹´ë“œ ì±„ìš°ê¸°
        const grid = section.querySelector('.grid');
        if (group.members.length === 0) {
            grid.innerHTML = '<p style="color:#aaa; font-size:0.9rem;">ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            group.members.forEach(memberId => {
                // ì¹´ë“œ ìƒì„± ë° ë°ì´í„° ìš”ì²­
                const card = createCardElement(memberId, group.id);
                grid.appendChild(card);
                fetchStreamerData(memberId, card);
            });
        }
        return section;
    }

    // ì¹´ë“œ ìš”ì†Œ ë§Œë“¤ê¸°
    function createCardElement(id, groupId) {
        const card = document.createElement('div');
        card.className = 'card';
        card.id = `card-${groupId}-${id}`; // ID ì¤‘ë³µ ë°©ì§€ (ê·¸ë£¹ë³„ë¡œ êµ¬ë¶„)
        
        // ì‚­ì œ ë²„íŠ¼ (í•´ë‹¹ ê·¸ë£¹ì—ì„œë§Œ ì‚­ì œ)
        const delBtn = document.createElement('div');
        delBtn.className = 'delete-btn';
        delBtn.innerText = 'X';
        delBtn.style.display = isAdmin ? 'block' : 'none';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            removeMember(id, groupId);
        };

        card.innerHTML = `
            <div class="profile-wrapper">
                <img src="" onerror="this.src='https://via.placeholder.com/90?text=Wait'">
                <div class="badges">
                    <span class="badge live">LIVE</span>
                    <span class="badge multi" id="multi-${groupId}-${id}">ğŸ”—</span>
                </div>
            </div>
            <h3>${id}</h3>
            <p class="status-text">ë¡œë”©ì¤‘...</p>
        `;
        card.prepend(delBtn);
        card.onclick = (e) => { if(!e.target.classList.contains('delete-btn')) openModal(id); };

        // êµì§‘í•©(ë©€í‹° ê·¸ë£¹) ì²´í¬
        checkMultiGroup(id, groupId);
        
        return card;
    }

    // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—”ì§„ í˜¸ì¶œ)
    async function fetchStreamerData(id, card) {
        try {
            const res = await fetch(`/api/info?id=${id}`);
            const data = await res.json();
            
            if (data.isLive) card.classList.add('is-live');
            
            const img = card.querySelector('img');
            img.src = data.img || 'https://via.placeholder.com/90';
            
            const name = card.querySelector('h3');
            name.innerText = data.name;

            const status = card.querySelector('.status-text');
            status.innerText = data.isLive ? 'ğŸ”´ ë°©ì†¡ì¤‘' : 'âš« ì˜¤í”„ë¼ì¸';

        } catch (err) {
            console.error(err);
        }
    }

    // ğŸ”— êµì§‘í•© í™•ì¸ ë¡œì§
    function checkMultiGroup(id, currentGroupId) {
        let count = 0;
        // ì „ì²´ ê·¸ë£¹ì„ ë’¤ì ¸ì„œ ì´ ì‚¬ëŒì´ ëª‡ ë²ˆ ë‚˜ì˜¤ë‚˜ í™•ì¸
        dashboardData.groups.forEach(g => { if(g.members.includes(id)) count++; });
        if(dashboardData.ungrouped.includes(id)) count++;

        // 2ê³³ ì´ìƒ ì†í•´ìˆìœ¼ë©´ ë±ƒì§€ í‘œì‹œ
        if (count > 1) {
            setTimeout(() => {
                const badge = document.getElementById(`multi-${currentGroupId}-${id}`);
                if(badge) badge.style.display = 'inline-block';
            }, 100);
        }
    }

    // --- ê´€ë¦¬ì ê¸°ëŠ¥ë“¤ ---

    function toggleAdmin() {
        if (!isAdmin) {
            if (prompt("ë¹„ë°€ë²ˆí˜¸:") === ADMIN_PASSWORD) {
                isAdmin = true;
                document.getElementById('admin-panel').style.display = 'block';
                document.querySelectorAll('.delete-btn').forEach(b => b.style.display = 'block');
                document.querySelectorAll('.group-controls').forEach(b => b.style.display = 'flex');
            }
        } else {
            isAdmin = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.querySelectorAll('.delete-btn').forEach(b => b.style.display = 'none');
            document.querySelectorAll('.group-controls').forEach(b => b.style.display = 'none');
        }
    }

    // ê·¸ë£¹ ìƒì„±
    function addNewGroup() {
        const name = document.getElementById('new-group-name').value;
        if (!name) return alert('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        
        const newId = 'g_' + Date.now(); // ê³ ìœ  ID ìƒì„±
        dashboardData.groups.push({ id: newId, name: name, members: [] });
        document.getElementById('new-group-name').value = '';
        saveData();
    }

    // ê·¸ë£¹ ìˆœì„œ ë³€ê²½ (direction: -1 ìœ„ë¡œ, 1 ì•„ë˜ë¡œ)
    function moveGroup(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= dashboardData.groups.length) return;
        
        // ìˆœì„œ ë°”ê¾¸ê¸° (Swap)
        const temp = dashboardData.groups[index];
        dashboardData.groups[index] = dashboardData.groups[newIndex];
        dashboardData.groups[newIndex] = temp;
        saveData();
    }

    // ê·¸ë£¹ ì‚­ì œ
    function deleteGroup(index) {
        if (!confirm("ê·¸ë£¹ì„ ì‚­ì œí•˜ë©´ ë©¤ë²„ë“¤ì€ 'ë¯¸ë¶„ë¥˜'ë¡œ ì´ë™ë©ë‹ˆë‹¤.")) return;
        
        const members = dashboardData.groups[index].members;
        // ë©¤ë²„ë“¤ì„ ë¯¸ë¶„ë¥˜ë¡œ ì´ë™
        dashboardData.ungrouped.push(...members);
        // ê·¸ë£¹ ì‚­ì œ
        dashboardData.groups.splice(index, 1);
        saveData();
    }

    // ìŠ¤íŠ¸ë¦¬ë¨¸ ì¶”ê°€
    function addStreamer() {
        const id = document.getElementById('new-streamer-id').value.trim();
        const targetGroupId = document.getElementById('group-select').value;
        
        if (!id) return alert('ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”');

        // í•´ë‹¹ ê·¸ë£¹ ì°¾ê¸°
        if (targetGroupId === 'ungrouped') {
            if (!dashboardData.ungrouped.includes(id)) dashboardData.ungrouped.push(id);
        } else {
            const group = dashboardData.groups.find(g => g.id === targetGroupId);
            if (group && !group.members.includes(id)) group.members.push(id);
        }

        document.getElementById('new-streamer-id').value = '';
        saveData();
    }

    // ë©¤ë²„ ì‚­ì œ
    function removeMember(id, groupId) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        
        if (groupId === 'g_ungrouped') {
            dashboardData.ungrouped = dashboardData.ungrouped.filter(m => m !== id);
        } else {
            const group = dashboardData.groups.find(g => g.id === groupId);
            if (group) group.members = group.members.filter(m => m !== id);
        }
        saveData();
    }

    // ê´€ë¦¬ì UI ì—…ë°ì´íŠ¸ (Select ë°•ìŠ¤ ì±„ìš°ê¸° ë“±)
    function updateAdminUI() {
        const select = document.getElementById('group-select');
        select.innerHTML = '';
        
        dashboardData.groups.forEach(g => {
            select.innerHTML += `<option value="${g.id}">${g.name}</option>`;
        });
        select.innerHTML += `<option value="ungrouped">ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)</option>`;
    }

    // ëª¨ë‹¬ ê´€ë ¨ (ê¸°ì¡´ ìœ ì§€)
    function openModal(name) {
        document.getElementById('modal').style.display='block';
        document.getElementById('modal-title').innerText=name;
        // (ê°€ì§œ ë Œë”ë§ ìœ ì§€)
        const g=document.getElementById('calendar-grid'); g.innerHTML='';
        for(let i=0;i<30;i++)g.innerHTML+=`<div class="cal-day">${i+1}</div>`;
        new Chart(document.getElementById('timeChart'),{type:'line',data:{labels:[1,2],datasets:[{data:[10,20]}]}});
    }
    function closeModal(){document.getElementById('modal').style.display='none';}
    window.onclick=(e)=>{if(e.target==document.getElementById('modal'))closeModal();}

    init();
</script>

</body>
</html>
