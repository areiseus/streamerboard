<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Live Board</title>
    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        body { margin: 0; background: #e9ecef; font-family: 'Pretendard', sans-serif; padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; position: relative; padding-bottom: 100px; }
        
        h1 { text-align: center; margin-bottom: 40px; color: #343a40; font-weight: 900; letter-spacing: -1px; }

        /* [ìƒë‹¨: ê·¸ë£¹ í’ì„  ì˜ì—­] */
        #balloon-area {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 60px; /* ë¯¸ë¶„ë¥˜ ì˜ì—­ê³¼ ê°„ê²© */
        }

        /* í’ì„  (Balloon) ìŠ¤íƒ€ì¼ */
        .balloon {
            background: #fff;
            border: 3px solid #333;
            border-radius: 30px;
            padding: 20px;
            min-width: 250px;
            max-width: 100%; /* ìœ ë™ì  ë„ˆë¹„ */
            box-shadow: 8px 8px 0px rgba(0,0,0,0.15);
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .balloon:hover { transform: translateY(-5px); }

        .balloon-title {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: #333;
            color: #fff;
            padding: 5px 20px;
            border-radius: 20px;
        }

        /* í’ì„  ë‚´ë¶€ ê·¸ë¦¬ë“œ */
        .member-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        /* [ì¹´ë“œ ìŠ¤íƒ€ì¼] */
        .card { 
            width: 100px;
            text-align: center; cursor: pointer; 
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px 5px;
            transition: 0.2s;
            position: relative;
            border: 1px solid #ddd;
        }
        .card:hover { background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .profile-img { 
            width: 65px; height: 65px; border-radius: 50%; 
            background: #eee; object-fit: cover; margin-bottom: 8px; 
            border: 3px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* ë¼ì´ë¸Œ íš¨ê³¼ */
        .card.is-live { border-color: #ff4757; background: #fff5f5; }
        .card.is-live .profile-img { border-color: #ff4757; animation: pulse 2s infinite; }

        .name { 
            font-size: 0.95rem; font-weight: bold; color: #333; margin-bottom: 5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* [íƒœê·¸ ì˜ì—­] í”„ë¡œí•„ ì‚¬ì§„ ì•„ë˜ ê·¸ë£¹ë“¤ ë‚˜ì—´ */
        .tags {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 3px; margin-bottom: 5px;
        }
        .tag-badge {
            font-size: 0.65rem; padding: 2px 5px; border-radius: 4px;
            background: #495057; color: #fff; font-weight: bold;
        }
        /* í”Œë«í¼ ë°°ì§€ */
        .pf-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: #fff; font-weight: bold; display:inline-block; margin-bottom: 3px;}
        .soop { background: #42C769; } .chzzk { background: #00E59D; color: #111; }

        .status-text { font-size: 0.75rem; color: #888; }

        /* [í•˜ë‹¨: ë¯¸ë¶„ë¥˜(No Group) ì˜ì—­] */
        #unclassified-area {
            border-top: 3px dashed #bbb;
            padding-top: 30px;
            margin-top: 50px;
        }
        .footer-title {
            font-size: 1.2rem; font-weight: bold; color: #666; margin-bottom: 20px;
            display: flex; align-items: center; gap: 10px;
        }
        
        /* ë¯¸ë¶„ë¥˜ìš© ê·¸ë¦¬ë“œ (ë‹¨ìˆœ ë‚˜ì—´) */
        .simple-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 15px;
        }

        .admin-link { position: absolute; top: 0; right: 0; font-size: 1.5rem; text-decoration: none; opacity: 0.3; }
        .admin-link:hover { opacity: 1; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸˆ Streamer Groups</h1>
    <a href="admin.html" class="admin-link" title="ê´€ë¦¬ì í˜ì´ì§€">âš™ï¸</a>

    <div id="balloon-area">
        <p style="width:100%; text-align:center;">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <div id="unclassified-area" style="display:none;">
        <div class="footer-title">
            <span>ğŸ“‚ ë¯¸ë¶„ë¥˜ ìŠ¤íŠ¸ë¦¬ë¨¸ (No Group)</span>
            <span id="no-group-count" style="font-size:0.9rem; background:#ddd; padding:2px 8px; border-radius:10px;">0</span>
        </div>
        <div id="no-group-grid" class="simple-grid"></div>
    </div>
</div>

<script>
    async function init() {
        try {
            const res = await fetch('/api/get_list');
            const data = await res.json();

            if (!data || data.length === 0) {
                document.getElementById('balloon-area').innerHTML = '<p>ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // 1. ë°ì´í„° ë¶„ë¥˜ (ê·¸ë£¹ ìœ ë¬´)
            const grouped = {}; // ë©”ì¸ ê·¸ë£¹ë³„ë¡œ ë¬¶ì„ ê°ì²´
            const noGroupList = []; // ê·¸ë£¹ ì—†ëŠ” ì‚¬ëŒ

            data.forEach(m => {
                const myGroups = []; // ì´ ì‚¬ëŒì˜ ëª¨ë“  ê·¸ë£¹ íƒœê·¸ ìˆ˜ì§‘

                // (1) í†µí•© group_name ì²˜ë¦¬
                if (m.group_name) {
                    m.group_name.split(',').forEach(g => {
                        if(g.trim()) myGroups.push(g.trim());
                    });
                }
                // (2) group_1, 2, 3 ì²˜ë¦¬
                if (m.group_1 && m.group_1.trim()) myGroups.push(m.group_1.trim());
                if (m.group_2 && m.group_2.trim()) myGroups.push(m.group_2.trim());
                if (m.group_3 && m.group_3.trim()) myGroups.push(m.group_3.trim());

                // ì¤‘ë³µ ì œê±°
                const uniqueGroups = [...new Set(myGroups)];

                // --- ë¶„ë¥˜ ë¡œì§ ---
                if (uniqueGroups.length === 0) {
                    // ê·¸ë£¹ ì—†ìŒ -> í•˜ë‹¨í–‰
                    noGroupList.push(m);
                } else {
                    // ê·¸ë£¹ ìˆìŒ -> "ì²« ë²ˆì§¸ ê·¸ë£¹(Main)"ì„ ê¸°ì¤€ìœ¼ë¡œ í’ì„ ì— ë„£ìŒ
                    // (ê·¸ë ¤ì£¼ì‹  ê·¸ë¦¼ì²˜ëŸ¼ ë­‰ì¹˜ê¸° ìœ„í•¨)
                    const mainGroup = uniqueGroups[0]; // ê°€ì¥ ì•ì— ìˆëŠ”ê²Œ ë©”ì¸ ê·¸ë£¹

                    if (!grouped[mainGroup]) grouped[mainGroup] = [];
                    
                    // ë©¤ë²„ ê°ì²´ì— 'tags' ì†ì„± ì¶”ê°€í•´ì„œ ì €ì¥ (í™”ë©´ í‘œì‹œìš©)
                    m._tags = uniqueGroups; 
                    grouped[mainGroup].push(m);
                }
            });

            renderBalloons(grouped);
            renderNoGroup(noGroupList);
            checkLive(data); // ë¼ì´ë¸Œ ì²´í¬ëŠ” ì „ì²´ ëŒ€ìƒìœ¼ë¡œ

        } catch (e) {
            console.error(e);
            document.getElementById('balloon-area').innerHTML = '<p>ë¡œë”© ì‹¤íŒ¨</p>';
        }
    }

    // [ìƒë‹¨] í’ì„  ë Œë”ë§
    function renderBalloons(groupedData) {
        const area = document.getElementById('balloon-area');
        area.innerHTML = '';

        // ê·¸ë£¹ ì´ë¦„ ìˆœ ì •ë ¬
        Object.keys(groupedData).sort().forEach(gName => {
            const members = groupedData[gName];

            // í’ì„  ìƒì„±
            const balloon = document.createElement('div');
            balloon.className = 'balloon';
            balloon.innerHTML = `
                <div class="balloon-title">${gName} <span style="font-size:0.8rem; opacity:0.7">(${members.length})</span></div>
                <div class="member-grid"></div>
            `;
            
            const grid = balloon.querySelector('.member-grid');

            members.forEach(m => {
                grid.appendChild(createCard(m));
            });

            area.appendChild(balloon);
        });
    }

    // [í•˜ë‹¨] ë¯¸ë¶„ë¥˜ ë Œë”ë§
    function renderNoGroup(list) {
        const area = document.getElementById('unclassified-area');
        const grid = document.getElementById('no-group-grid');
        const countSpan = document.getElementById('no-group-count');

        if (list.length === 0) {
            area.style.display = 'none';
            return;
        }

        area.style.display = 'block';
        countSpan.innerText = list.length;
        grid.innerHTML = '';

        list.forEach(m => {
            // ë¯¸ë¶„ë¥˜ëŠ” íƒœê·¸ê°€ ì—†ìœ¼ë¯€ë¡œ ë¹ˆ ë°°ì—´ ì „ë‹¬
            m._tags = [];
            grid.appendChild(createCard(m));
        });
    }

    // [ê³µí†µ] ì¹´ë“œ ìƒì„± í•¨ìˆ˜
    function createCard(m) {
        const pf = m.platform || 'soop';
        const isSoop = pf === 'soop' || pf === 'afreeca';
        const link = isSoop ? `https://play.afreecatv.com/${m.id}` : `https://chzzk.naver.com/live/${m.id}`;

        const card = document.createElement('div');
        card.className = 'card';
        card.setAttribute('data-id', m.id);
        card.onclick = () => window.open(link);

        // íƒœê·¸ HTML ìƒì„± (í”„ë¡œí•„ ì•„ë˜ì— ë¶™ìŒ)
        let tagsHtml = '';
        if (m._tags && m._tags.length > 0) {
            tagsHtml = '<div class="tags">';
            m._tags.forEach(t => {
                tagsHtml += `<span class="tag-badge">${t}</span>`;
            });
            tagsHtml += '</div>';
        }

        card.innerHTML = `
            <div style="position:relative; display:inline-block;">
                <img src="${m.profile_img || 'https://via.placeholder.com/65'}" class="profile-img">
                <div style="margin-top:-10px; margin-bottom:5px;">
                    <span class="pf-badge ${isSoop?'soop':'chzzk'}">${isSoop?'S':'C'}</span>
                </div>
            </div>
            <div class="name">${m.nickname || m.id}</div>
            
            ${tagsHtml} <div class="status-text">OFF</div>
        `;
        return card;
    }

    // ë¼ì´ë¸Œ ì²´í¬
    async function checkLive(allMembers) {
        const uniqueIds = [...new Set(allMembers.map(m => m.id))];
        const targets = uniqueIds.map(id => {
            const origin = allMembers.find(m => m.id === id);
            return { id: origin.id, platform: origin.platform };
        });

        try {
            const res = await fetch('/api/live', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: targets })
            });
            const results = await res.json();

            results.forEach(r => {
                const cards = document.querySelectorAll(`.card[data-id="${r.id}"]`);
                cards.forEach(card => {
                    const statusText = card.querySelector('.status-text');
                    if(r.isLive) {
                        card.classList.add('is-live');
                        statusText.innerHTML = `<span style="color:#ff4757; font-weight:bold">LIVE ${formatCount(r.viewers)}</span>`;
                    } else {
                        card.classList.remove('is-live');
                        statusText.innerText = 'OFF';
                    }
                });
            });
        } catch(e) { console.error(e); }
    }

    function formatCount(num) {
        if(!num) return '';
        if(num >= 10000) return (num/10000).toFixed(1) + 'ë§Œ';
        return num.toLocaleString();
    }

    init();
</script>
</body>
</html>
