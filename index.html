<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Board</title>
    <style>
        :root { --primary: #42C769; --bg: #F0F2F5; --card: #ffffff; --text: #2f3542; }
        body { margin: 0; background: var(--bg); font-family: 'Pretendard', -apple-system, sans-serif; color: var(--text); }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 40px 20px; position: relative; }
        
        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        header { text-align: center; margin-bottom: 30px; position: relative; }
        header h1 { color: #333; margin: 0; font-size: 2.5rem; letter-spacing: -1px; }
        
        /* ğŸ”¥ ê´€ë¦¬ì ë²„íŠ¼ (ìš°ì¸¡ ìƒë‹¨ ê³ ì •) */
        .admin-link-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #666;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .admin-link-btn:hover { background: #333; color: white; border-color: #333; }

        .group-section { margin-bottom: 40px; }
        .group-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .group-title { font-size: 1.4rem; font-weight: bold; color: #333; margin-right: 15px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .card.loading { animation: pulse 1.5s infinite; }

        .card { 
            position: relative; background: var(--card); border-radius: 20px; padding: 25px 15px; text-align: center; 
            cursor: pointer; transition: all 0.3s ease; border: 1px solid transparent; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .card.is-live { border-color: #ff4757; background: #fff5f5; }
        
        .profile-wrapper { position: relative; width: 90px; height: 90px; margin: 0 auto 15px; }
        .card img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid #eee; background: #eee;}
        .card.is-live img { border-color: #ff4757; box-shadow: 0 0 10px rgba(255, 71, 87, 0.5); }
        
        .badges { position: absolute; bottom: -5px; width: 100%; text-align: center; display: flex; justify-content: center; gap: 5px; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: bold; color: white; }
        .badge.live { background: #ff4757; display: none; }
        .card.is-live .badge.live { display: inline-block; }
        
        /* í”Œë«í¼ ë±ƒì§€ */
        .badge.platform { background: #333; display: inline-block; }
        .badge.soop { background: #42C769; }
        .badge.chzzk { background: #00E59D; color: #1e1e1e; }
        
        .status-text { font-size: 0.85rem; color: #888; margin-top: 5px;}
        .card.is-live .status-text { color: #ff4757; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Streamer Board</h1>
        <p>ì‹¤ì‹œê°„ ë°©ì†¡ í˜„í™©</p>
        <button class="admin-link-btn" onclick="location.href='admin.html'">âš™ï¸ ê´€ë¦¬ì</button>
    </header>

    <div id="dashboard-content">
        <p style="text-align:center; padding:50px; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</div>

<script>
    let dashboardData = { groups: [], ungrouped: [] };

    // 1. ì´ˆê¸°í™”: list.json ì½ê¸°
    async function init() {
        try {
            const listRes = await fetch('list.json?t=' + Date.now());
            if(listRes.ok) {
                dashboardData = await listRes.json();
                renderSkeleton();
                fetchLiveStatus();
            }
        } catch (e) { console.error("ì´ˆê¸°í™” ì‹¤íŒ¨:", e); }
    }

    // 2. ë¼ˆëŒ€ ê·¸ë¦¬ê¸°
    function renderSkeleton() {
        const container = document.getElementById('dashboard-content');
        container.innerHTML = '';
        
        const allGroups = [...dashboardData.groups];
        if(dashboardData.ungrouped.length > 0) {
            allGroups.push({ id: 'g_ungrouped', name: 'ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)', members: dashboardData.ungrouped });
        }

        allGroups.forEach(group => {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `
                <div class="group-header"><span class="group-title">${group.name}</span></div>
                <div class="grid" id="grid-${group.id}"></div>
            `;
            const grid = section.querySelector('.grid');
            
            group.members.forEach(member => {
                // memberê°€ ê°ì²´({id, platform})ì¼ ìˆ˜ë„ ìˆê³  ë¬¸ìì—´ì¼ ìˆ˜ë„ ìˆìŒ í˜¸í™˜ì„± ì²˜ë¦¬
                const id = typeof member === 'string' ? member : member.id;
                
                const card = document.createElement('div');
                card.className = 'card loading';
                card.id = `card-base-${id}`;
                card.innerHTML = `
                    <div class="profile-wrapper">
                        <img src="https://via.placeholder.com/90?text=..." style="opacity:0.5">
                    </div>
                    <h3>${id}</h3>
                    <p class="status-text">í™•ì¸ ì¤‘...</p>
                `;
                grid.appendChild(card);
            });
            container.appendChild(section);
        });
    }

    // 3. ì‹¤ì‹œê°„ ìƒíƒœ í™•ì¸ (api/live.js í˜¸ì¶œ)
    async function fetchLiveStatus() {
        const allItems = [];
        const pushMembers = (list) => list.forEach(m => {
            // ì¤‘ë³µ ì œê±° ë° í¬ë§· í†µì¼
            const item = typeof m === 'string' ? { id: m, platform: 'soop' } : m;
            if(!allItems.find(x => x.id === item.id)) allItems.push(item);
        });

        dashboardData.groups.forEach(g => pushMembers(g.members));
        pushMembers(dashboardData.ungrouped);

        try {
            const res = await fetch('/api/live', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: allItems })
            });
            
            const results = await res.json();
            updateUI(results);

        } catch (e) { console.error("ë¼ì´ë¸Œ ì²´í¬ ì‹¤íŒ¨:", e); }
    }

    // 4. í™”ë©´ ì—…ë°ì´íŠ¸
    function updateUI(results) {
        const statusMap = {};
        results.forEach(r => statusMap[r.id] = r);

        const container = document.getElementById('dashboard-content');
        container.innerHTML = ''; 

        const allGroups = [...dashboardData.groups];
        if(dashboardData.ungrouped.length > 0) allGroups.push({ id: 'g_ungrouped', name: 'ê¸°íƒ€ (ë¯¸ë¶„ë¥˜)', members: dashboardData.ungrouped });

        allGroups.forEach(group => {
            const section = document.createElement('div');
            section.className = 'group-section';
            section.innerHTML = `<div class="group-header"><span class="group-title">${group.name}</span></div><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            group.members.forEach(member => {
                const m = typeof member === 'string' ? { id: member, platform: 'soop' } : member;
                const data = statusMap[m.id] || { name: m.id, img: null, isLive: false, viewers: 0 };
                
                const card = createCardElement(m, data);
                grid.appendChild(card);
            });
            container.appendChild(section);
        });
    }

    function createCardElement(member, data) {
        const card = document.createElement('div');
        card.className = 'card';
        if (data.isLive) card.classList.add('is-live');
        
        // í”Œë«í¼ ë±ƒì§€
        const pClass = member.platform === 'chzzk' ? 'chzzk' : 'soop';
        const pName = member.platform === 'chzzk' ? 'C' : 'S';

        // ì´ë¯¸ì§€ (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
        const imgUrl = data.img || 'https://via.placeholder.com/90?text=NONE';

        card.innerHTML = `
            <div class="profile-wrapper">
                <img src="${imgUrl}">
                <div class="badges">
                    <span class="badge platform ${pClass}">${pName}</span>
                    <span class="badge live">LIVE</span>
                </div>
            </div>
            <h3>${data.name}</h3>
            <p class="status-text">
                ${data.isLive ? `ğŸ”´ ${data.viewers.toLocaleString()}ëª…` : 'âš« ì˜¤í”„ë¼ì¸'}
            </p>
        `;
        
        // í´ë¦­ ì‹œ í•´ë‹¹ í”Œë«í¼ ë°©ì†¡êµ­ìœ¼ë¡œ ì´ë™
        card.onclick = () => {
            if(data.link) window.open(data.link, '_blank');
        };
        return card;
    }

    init();
</script>

</body>
</html>
