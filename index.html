<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Grid-Layout Board</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* [기본 설정] */
        body { margin: 0; background: #e9ecef; font-family: 'Pretendard', sans-serif; overflow: hidden; }
        .container { width: 100vw; height: 100vh; position: relative; background: radial-gradient(circle, #f8f9fa 0%, #e9ecef 100%); }

        .admin-link { position: absolute; top: 20px; right: 20px; font-size: 2rem; text-decoration: none; opacity: 0.5; z-index: 1000; }
        .admin-link:hover { opacity: 1; }

        /* [레이어 설정] */
        #balloon-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none;}
        #card-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }

        /* [카드 스타일] 크기 약간 축소 및 사각형으로 변경 */
        .card {
            position: absolute;
            width: 90px; height: 110px; /* 약간 직사각형 */
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 10px;
            transform: translate(-50%, -50%);
            cursor: grab;
            box-sizing: border-box;
            border: 2px solid transparent;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .card:active { cursor: grabbing; }
        
        .profile-wrap {
            width: 60px; height: 60px; position: relative; margin-bottom: 8px;
        }
        .profile-img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 2px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .pf-badge {
            position: absolute; bottom: 0; right: 0;
            width: 18px; height: 18px; border-radius: 50%;
            color: #fff; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid #fff;
        }
        .soop { background: #42C769; } .chzzk { background: #00E59D; color:#333; }

        .name-tag {
            font-size: 0.85rem; font-weight: bold; color: #333;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px;
        }

        /* 라이브 효과 */
        .is-live { border-color: #ff4757; }
        .is-live .profile-img { border-color: #ff4757; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.6); }
            70% { box-shadow: 0 0 0 8px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* [풍선 스타일 개선] */
        .group-hull {
            fill-opacity: 0.1;
            stroke-width: 4px; /* 선 두께는 얇게 */
            stroke-opacity: 0.6;
            stroke-linejoin: round;
            mix-blend-mode: multiply;
            transition: d 0.3s ease-out; /* 부드러운 움직임 */
        }
        .group-label {
            font-size: 14px; font-weight: 800; fill: #555; text-anchor: middle;
            pointer-events: none; user-select: none;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }
    </style>
</head>
<body>

<div class="container">
    <a href="admin.html" class="admin-link">⚙️</a>
    <svg id="balloon-layer"></svg>
    <div id="card-layer"></div>
</div>

<script>
    let width = window.innerWidth;
    let height = window.innerHeight;
    const CARD_WIDTH = 90;
    const CARD_HEIGHT = 110;
    const COLLISION_RADIUS = 55; // 카드 간 최소 거리

    async function init() {
        try {
            const res = await fetch('/api/get_list');
            const data = await res.json();
            if (!data || data.length === 0) return;

            // 1. 데이터 준비
            const nodes = data.map(d => ({
                ...d,
                x: width/2 + (Math.random()-0.5)*200, 
                y: height/2 + (Math.random()-0.5)*200,
                pf: d.platform || 'soop'
            }));

            const groups = {};
            nodes.forEach(node => {
                node.groups = parseGroups(node);
                node.groups.forEach(gName => {
                    if (!groups[gName]) groups[gName] = [];
                    groups[gName].push(node);
                });
            });

            // 그룹 리스트 (큰 그룹 우선)
            const groupList = Object.keys(groups).map(key => ({
                name: key, members: groups[key], size: groups[key].length
            })).sort((a, b) => b.size - a.size);

            const colorScale = d3.scaleOrdinal(d3.schemeSet3);

            // ---------------------------------------------------
            // [핵심 1] 물리 엔진 설정 (그리드 포스 적용)
            // ---------------------------------------------------
            const simulation = d3.forceSimulation(nodes)
                .force("center", d3.forceCenter(width / 2, height / 2).strength(0.05))
                // 겹침 방지 (조금 더 강하게)
                .force("collide", d3.forceCollide().radius(COLLISION_RADIUS).strength(0.8).iterations(3))
                // 전체적으로 퍼지게 하는 힘
                .force("charge", d3.forceManyBody().strength(-200).distanceMax(500));

            // 커스텀 힘: "그룹 내 그리드 정렬"
            simulation.force("grid-align", alpha => {
                groupList.forEach(group => {
                    if(group.size <= 1) return; // 1명은 정렬 불필요

                    // 그룹의 현재 중심점 계산
                    let titleYOffset = 40; // 타이틀 공간 확보
                    let meanX = d3.mean(group.members, d => d.x);
                    let meanY = d3.mean(group.members, d => d.y) + titleYOffset;

                    // 그리드 계산 (열 개수 자동 계산)
                    const cols = Math.ceil(Math.sqrt(group.size * 1.2)); 
                    const spacingX = CARD_WIDTH + 15; // 가로 간격
                    const spacingY = CARD_HEIGHT + 15; // 세로 간격

                    // 멤버들을 그리드 목표 지점으로 당김
                    group.members.forEach((m, i) => {
                        // 목표 그리드 좌표 계산 (중심점 기준)
                        const col = i % cols;
                        const row = Math.floor(i / cols);
                        const targetX = meanX + (col - (cols-1)/2) * spacingX;
                        const targetY = meanY + (row - (Math.ceil(group.size/cols)-1)/2) * spacingY;

                        // 목표 지점으로 부드럽게 이동 (alpha 값 활용)
                        // 여러 그룹에 속한 경우 힘이 합쳐져서 중간 지점을 찾게 됨
                        m.vx += (targetX - m.x) * 0.15 * alpha;
                        m.vy += (targetY - m.y) * 0.15 * alpha;
                    });
                });
            });

            // ---------------------------------------------------
            // [렌더링 및 루프]
            // ---------------------------------------------------
            const svg = d3.select("#balloon-layer");
            const cardLayer = d3.select("#card-layer");

            const cardElements = cardLayer.selectAll(".card")
                .data(nodes)
                .enter().append("div")
                .attr("class", "card")
                .html(d => `
                    <div class="profile-wrap">
                        <img src="${d.profile_img || 'https://via.placeholder.com/60'}" class="profile-img">
                        <div class="pf-badge ${d.pf==='soop'||d.pf==='afreeca'?'soop':'chzzk'}">
                            ${d.pf==='soop'||d.pf==='afreeca'?'S':'C'}
                        </div>
