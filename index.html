<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamer Board</title>
    <style>
        body { margin: 0; background: #1a1a1a; font-family: 'Pretendard', sans-serif; padding: 20px; color: #fff; }
        .container { max-width: 1100px; margin: 0 auto; position: relative; }
        
        /* ê·¸ë£¹ ì œëª© ìŠ¤íƒ€ì¼ */
        .group-title { 
            font-size: 1.4rem; font-weight: bold; margin: 40px 0 15px; 
            border-bottom: 2px solid #444; padding-bottom: 10px; display:block; color:#f1c40f; 
        }
        
        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 20px; 
        }
        
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: #2a2a2a; padding: 20px; border-radius: 12px; 
            text-align: center; cursor: pointer; transition: 0.2s; 
            border: 2px solid #333; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); border-color: #555; background: #333; }
        
        /* ë¼ì´ë¸Œ ìƒíƒœ ìŠ¤íƒ€ì¼ */
        .card.is-live { border-color: #ff4757; background: #2d1a1a; box-shadow: 0 0 15px rgba(255, 71, 87, 0.2); }
        
        .profile-img { 
            width: 70px; height: 70px; border-radius: 50%; 
            background: #444; object-fit: cover; margin-bottom: 10px; border: 2px solid #444; 
        }
        .card.is-live .profile-img { border-color: #ff4757; }

        .name { font-size: 1rem; font-weight: bold; margin: 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; color: #111; font-weight: bold; margin-right: 5px; vertical-align: middle; }
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
        
        .status { color: #888; font-size: 0.85rem; margin-top: 5px; }
        
        /* ê´€ë¦¬ì ë§í¬ */
        .admin-link { 
            position: absolute; top: 0; right: 0; 
            font-size: 1.5rem; text-decoration: none; cursor: pointer;
            transition: transform 0.3s; opacity: 0.5;
        }
        .admin-link:hover { transform: rotate(90deg); opacity: 1; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; margin-bottom: 40px;">ğŸ“º Streamer Live Board</h1>
    
    <a href="admin.html" class="admin-link" title="ê´€ë¦¬ì í˜ì´ì§€">âš™ï¸</a>
    
    <div id="board">
        <p style="text-align:center; color:#777; margin-top:50px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
</div>

<script>
    // -----------------------------------------------------------
    // [í•µì‹¬ ë¡œì§]
    // 1. group_name, group_1, 2, 3ì„ ëª¨ë‘ ì½ì–´ì„œ
    // 2. í•´ë‹¹ë˜ëŠ” ëª¨ë“  ê·¸ë£¹ ì„¹ì…˜ì— ì¹´ë“œë¥¼ ë³µì œí•´ì„œ ë¿Œë¦¼
    // 3. ë¼ì´ë¸Œ í™•ì¸ ì‹œ ëª¨ë“  ì¹´ë“œë¥¼ ë™ì‹œì— ê°±ì‹  (querySelectorAll)
    // -----------------------------------------------------------

    async function init() {
        try {
            const res = await fetch('/api/get_list');
            const data = await res.json();

            if (!data || data.length === 0) {
                document.getElementById('board').innerHTML = '<p style="text-align:center; margin-top:50px;">ë“±ë¡ëœ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ê·¸ë£¹ë³„ë¡œ ë°ì´í„° ë¶„ë¥˜
            const grouped = {};
            
            data.forEach(m => {
                // í•œ ëª…ì˜ ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì†í•œ ëª¨ë“  ê·¸ë£¹ ì´ë¦„ì„ ìˆ˜ì§‘ (Setìœ¼ë¡œ ì¤‘ë³µ ì œê±°)
                const myGroups = new Set();

                // 1) ê¸°ì¡´ group_name (ì‰¼í‘œ êµ¬ë¶„) ì²˜ë¦¬
                if (m.group_name) {
                    m.group_name.split(',').forEach(g => {
                        const clean = g.trim();
                        if(clean) myGroups.add(clean);
                    });
                }

                // 2) ì‹ ê·œ ì»¬ëŸ¼ (group_1, 2, 3) ì²˜ë¦¬
                if (m.group_1 && m.group_1.trim()) myGroups.add(m.group_1.trim());
                if (m.group_2 && m.group_2.trim()) myGroups.add(m.group_2.trim());
                if (m.group_3 && m.group_3.trim()) myGroups.add(m.group_3.trim());

                // ë§Œì•½ ê·¸ë£¹ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ 'ë¯¸ë¶„ë¥˜'ë¡œ ì²˜ë¦¬
                if (myGroups.size === 0) myGroups.add('ë¯¸ë¶„ë¥˜');

                // ìˆ˜ì§‘ëœ ê·¸ë£¹ë“¤ì— ê°ê° ë©¤ë²„ ì¶”ê°€
                myGroups.forEach(gName => {
                    if (!grouped[gName]) grouped[gName] = [];
                    grouped[gName].push(m);
                });
            });

            render(grouped);
            checkLive(data);

        } catch (e) {
            console.error(e);
            document.getElementById('board').innerHTML = '<p style="text-align:center">ë¡œë”© ì‹¤íŒ¨</p>';
        }
    }

    function render(groupedData) {
        const board = document.getElementById('board');
        board.innerHTML = '';

        // ê·¸ë£¹ ì´ë¦„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ë Œë”ë§
        Object.keys(groupedData).sort().forEach(gName => {
            const members = groupedData[gName];
            
            // ì„¹ì…˜ ìƒì„±
            const section = document.createElement('div');
            section.innerHTML = `<span class="group-title">ğŸ“‚ ${gName}</span><div class="grid"></div>`;
            const grid = section.querySelector('.grid');

            members.forEach(m => {
                const pf = m.platform || 'soop'; // ê¸°ë³¸ê°’
                const isSoop = pf === 'soop' || pf === 'afreeca';
                
                // ë§í¬ ìƒì„±
                const link = isSoop
                    ? `https://play.afreecatv.com/${m.id}`
                    : `https://chzzk.naver.com/live/${m.id}`;
                
                // ì¹´ë“œ ìƒì„±
                const card = document.createElement('div');
                card.className = 'card';
                
                // [ì¤‘ìš”] ID ëŒ€ì‹  data-id ì†ì„± ì‚¬ìš© (í•œ ëª…ì´ ì—¬ëŸ¬ ê³³ì— ë‚˜íƒ€ë‚˜ë¯€ë¡œ)
                card.setAttribute('data-id', m.id); 
                card.onclick = () => window.open(link);

                card.innerHTML = `
                    <img src="${m.profile_img || 'https://via.placeholder.com/80'}" class="profile-img">
                    <div><span class="badge ${isSoop ? 'soop' : 'chzzk'}">${isSoop ? 'SOOP' : 'CHZZK'}</span></div>
                    <div class="name">${m.nickname || m.id}</div>
                    <p class="status">ì˜¤í”„ë¼ì¸</p>
                `;
                grid.appendChild(card);
            });
            board.appendChild(section);
        });
    }

    // ë¼ì´ë¸Œ ìƒíƒœ ì²´í¬ (ë°°ì¹˜ ì²˜ë¦¬)
    async function checkLive(allMembers) {
        // ì¤‘ë³µ ì œê±°ëœ ID ëª©ë¡ ë§Œë“¤ê¸° (API í˜¸ì¶œ ìµœì†Œí™”)
        const uniqueIds = [...new Set(allMembers.map(m => m.id))];
        
        // ìš”ì²­ ë°ì´í„° êµ¬ì„± (IDì™€ í”Œë«í¼ ì •ë³´ ë§¤í•‘ì´ í•„ìš”í•˜ë¯€ë¡œ ì›ë³¸ ë°ì´í„° í™œìš©)
        const targets = uniqueIds.map(id => {
            const original = allMembers.find(m => m.id === id);
            return { id: original.id, platform: original.platform };
        });

        try {
            const res = await fetch('/api/live', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ items: targets })
            });
            const results = await res.json();

            // ê²°ê³¼ ë°˜ì˜
            results.forEach(r => {
                // [í•µì‹¬] querySelectorAllë¡œ í™”ë©´ì— ìˆëŠ” 'ëª¨ë“ ' í•´ë‹¹ ë©¤ë²„ ì¹´ë“œë¥¼ ì°¾ì•„ì„œ ë™ì‹œì— ì—…ë°ì´íŠ¸
                const cards = document.querySelectorAll(`.card[data-id="${r.id}"]`);
                
                cards.forEach(card => {
                    const statusText = card.querySelector('.status');
                    
                    if(r.isLive) {
                        card.classList.add('is-live');
                        statusText.innerHTML = `<span style="color:#ff4757; font-weight:bold;">ğŸ”´ LIVE (${r.viewers ? r.viewers.toLocaleString() : 0}ëª…)</span>`;
                    } else {
                        card.classList.remove('is-live');
                        statusText.innerText = 'ì˜¤í”„ë¼ì¸';
                    }
                });
            });
        } catch(e) { console.error("ë¼ì´ë¸Œ ì²´í¬ ì‹¤íŒ¨:", e); }
    }

    // ì‹œì‘
    init();
</script>
</body>
</html>
