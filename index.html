<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DB ê´€ë¦¬ì - ë¡œê·¸ì¸</title>
    <style>
        body { background: #222; color: #fff; padding: 20px; font-family: 'Pretendard', sans-serif; max-width: 1000px; margin: 0 auto; }
        
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .login-box { text-align: center; background: #333; padding: 30px; border-radius: 10px; border: 1px solid #555; }
        
        /* ê´€ë¦¬ì í™”ë©´ ìŠ¤íƒ€ì¼ (ì²˜ìŒì—” ìˆ¨ê¹€) */
        #admin-content { display: none; }
        
        input, select { padding: 10px; background: #444; border: 1px solid #555; color: white; border-radius: 5px; margin-right: 5px; }
        button { cursor: pointer; border: none; border-radius: 5px; font-weight: bold; padding: 10px 15px; }
        .list-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .list-table th { background: #444; padding: 10px; text-align: left; }
        .list-table td { border-bottom: 1px solid #555; padding: 10px; }
        .badge { padding: 3px 6px; border-radius: 3px; font-size: 0.8rem; font-weight: bold; color:black; }
        .soop { background: #42C769; } .chzzk { background: #00E59D; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>ğŸ”’ ê´€ë¦¬ì ì ‘ì†</h2>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:15px;">admin.jsonì— ì„¤ì •ëœ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeyup="if(event.key==='Enter') checkPassword()">
            <button onclick="checkPassword()" style="background:#0984e3; color:white;">ì…ì¥</button>
        </div>
    </div>

    <div id="admin-content">
        <h2 style="text-align:center">ğŸ› ï¸ ìŠ¤íŠ¸ë¦¬ë¨¸ DB ê´€ë¦¬</h2>
        <a href="index.html" style="color:#aaa; float:right; text-decoration:none;">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>

        <div style="background: #333; padding: 20px; border-radius: 10px; margin-bottom: 30px; margin-top: 40px;">
            <h3>â• ìŠ¤íŠ¸ë¦¬ë¨¸ ë“±ë¡ (DB ì €ì¥)</h3>
            <select id="pf"><option value="soop">ğŸŒ² SOOP</option><option value="chzzk">âš¡ CHZZK</option></select>
            <input type="text" id="mId" placeholder="ì•„ì´ë”” (UID)">
            <input type="text" id="gName" placeholder="ê·¸ë£¹ëª… (DB: group_id)" list="groupList">
            <datalist id="groupList"></datalist>
            <button onclick="registerStreamer()" style="background:#0984e3; color:white">ğŸ’¾ ì €ì¥</button>
        </div>

        <h3>ğŸ“‹ ë“±ë¡ëœ ëª©ë¡ (<span id="totalCnt">0</span>ëª…)</h3>
        <button onclick="updateAll()" style="background:#e17055; color:white;">âš¡ [ì „ì²´ ê°±ì‹ ] (í†µê³„/ê¸°ë¡ ì €ì¥)</button>

        <table class="list-table">
            <thead>
                <tr>
                    <th>ê·¸ë£¹ (ID)</th>
                    <th>í”Œë«í¼</th>
                    <th>ì•„ì´ë””</th>
                    <th>ë‹‰ë„¤ì„</th>
                    <th>ë°©ì†¡êµ­ ê°œì„¤ì¼</th>
                    <th>ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>

<script>
    // --- [1] ë¡œê·¸ì¸ ë¡œì§ ---
    async function checkPassword() {
        const inputPw = document.getElementById('adminPw').value;
        
        try {
            // admin.json íŒŒì¼ì„ ì½ì–´ì˜´
            const res = await fetch('admin.json');
            if (!res.ok) {
                alert("admin.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const config = await res.json();
            
            // ë¹„ë°€ë²ˆí˜¸ ë¹„êµ (admin.json ì•ˆì— {"password": "ì„¤ì •ëœë¹„ë²ˆ"} í˜•ì‹ì´ ìˆë‹¤ê³  ê°€ì •)
            if (inputPw === config.password) {
                document.getElementById('login-overlay').style.display = 'none'; // ì˜¤ë²„ë ˆì´ ìˆ¨ê¹€
                document.getElementById('admin-content').style.display = 'block'; // ë‚´ìš© í‘œì‹œ
                loadList(); // ë°ì´í„° ë¡œë“œ ì‹œì‘
            } else {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                document.getElementById('adminPw').value = '';
            }
        } catch (e) {
            console.error(e);
            alert("ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // --- [2] ë°ì´í„° ê´€ë¦¬ ë¡œì§ (ê¸°ì¡´ ìœ ì§€) ---
    async function loadList() {
        const res = await fetch('/api/get_list'); 
        const data = await res.json();
        
        const tbody = document.getElementById('listBody');
        const dlist = document.getElementById('groupList');
        document.getElementById('totalCnt').innerText = data.length;
        tbody.innerHTML = '';
        dlist.innerHTML = '';

        const groups = [...new Set(data.map(d => d.group_id).filter(Boolean))];
        groups.forEach(g => dlist.innerHTML += `<option value="${g}">`);

        data.forEach(m => {
            const pfClass = m.platform === 'chzzk' ? 'chzzk' : 'soop';
            tbody.innerHTML += `
                <tr>
                    <td style="color:#fdcb6e; font-weight:bold">${m.group_id || 'ë¯¸ë¶„ë¥˜'}</td>
                    <td><span class="badge ${pfClass}">${m.platform}</span></td>
                    <td>${m.id}</td>
                    <td>${m.nickname || '-'}</td>
                    <td>${m.station_open_date || '-'}</td>
                    <td>${m.is_active ? 'âœ…' : 'ğŸš«'}</td>
                </tr>
            `;
        });
        return data;
    }

    async function registerStreamer() {
        const id = document.getElementById('mId').value;
        const pf = document.getElementById('pf').value;
        const group = document.getElementById('gName').value;

        if(!id) return alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const btn = document.querySelector('button[onclick="registerStreamer()"]');
        btn.innerText = "â³ ì²˜ë¦¬ ì¤‘...";

        try {
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, platform: pf, group_name: group }) 
            });
            
            if(res.ok) {
                alert("ë“±ë¡ ì™„ë£Œ!");
                document.getElementById('mId').value = '';
                loadList();
            } else {
                alert("ë“±ë¡ ì‹¤íŒ¨");
            }
        } catch(e) { console.error(e); alert("ì—ëŸ¬ ë°œìƒ"); }
        btn.innerText = "ğŸ’¾ ì €ì¥";
    }

    async function updateAll() {
        if(!confirm("ëª¨ë“  ì •ë³´ë¥¼ ê°±ì‹ í•˜ê³  ì˜¤ëŠ˜ ë‚ ì§œ í†µê³„ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        
        const res = await fetch('/api/get_list');
        const data = await res.json();
        const targets = data.map(m => ({ id: m.id, platform: m.platform }));

        await fetch('/api/sync', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ items: targets })
        });
        
        alert("âœ… ê°±ì‹  ì™„ë£Œ");
        loadList();
    }
</script>
</body>
</html>
